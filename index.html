<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SUSHI メ</title>
<link rel="stylesheet" href="style.css">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600&display=swap" rel="stylesheet">


<!-- Open Graph для соцсетей -->
<meta property="og:title" content="SUSHI メ" />
<meta property="og:image" content="https://sushix0.github.io/SUSHI-X/Foto/Logo.png" />
<meta property="og:type" content="website" />
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DM67PTW8TB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DM67PTW8TB');
</script>

<body>


<div class="wrap">
  <header class="brand">
    <!-- Центрированный логотип -->
    <h1 class="logo"><span>SUSHI</span> <span class="jp">メ</span></h1>

<div class="lang-switcher">
  <a href="" class="lang-btn active">ET</a>
  <a href="ru/" class="lang-btn">RU</a>
  <a href="en/" class="lang-btn">EN</a>
</div>

  </header>
  <div class="note-orders-disabled" id="orders-disabled-note" style="display:none;">NB! Заказы временно не принимаются</div>




<!-- Основной фиксированный бар -->
<div class="menu-filters" id="menuFilters">
  <button>Предложения</button>
  <button>Урамаки</button>
  <button>Футомаки</button>
  <button>Маки</button>
  <button>Темпура</button>
  <button>Запечённые</button>
  <button>Нигири</button>
  <button>Наборы</button>
  <button>Дополнительно</button>
</div>

<!-- Плавающий бар -->
<div class="menu-filters-floating" id="menuFiltersFloating">
  <button>Предложения</button>
  <button>Урамаки</button>
  <button>Футомаки</button>
  <button>Маки</button>
  <button>Темпура</button>
  <button>Запечённые</button>
  <button>Нигири</button>
  <button>Наборы</button>
  <button>Дополнительно</button>
</div>


  <main>

<section class="menu-section" id="specialOffers">
  <h2 class="section-title">Предложения</h2>
  <div class="grid"></div>
</section>

  <!-- Раздел: Урамаки -->
  <section class="menu-section">
    <h2 class="section-title">Урамаки</h2>
    <div class="grid">
      <article class="card" data-id="филадельфия">
        <div class="photo" style="background-image:url('Foto/Shushi-1.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Филадельфия</span><span class="label-jp"><span class="scroll-text">フィラデルフィア</span></span></h3>
          <p class="ingredients">Лосось · Philadelphia · Огурец · Авокадо</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="снежный_краб">
        <div class="photo" style="background-image:url('Foto/Shushi-10.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Снежный краб</span><span class="label-jp"><span class="scroll-text">スノークラブ</span></span></h3>
          <p class="ingredients">Снежный краб · Philadelphia · Огурец</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="калифорния">
        <div class="photo" style="background-image:url('Foto/Shushi-11.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Калифорния</span><span class="label-jp"><span class="scroll-text">カリフォルニア</span></span></h3>
          <p class="ingredients">Снежный краб · Philadelphia · Огурец · Масаго</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="аляска">
        <div class="photo" style="background-image:url('Foto/Shushi-8.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Аляска</span><span class="label-jp"><span class="scroll-text">アラスカ</span></span></h3>
          <p class="ingredients">Угорь · Лосось · Philadelphia · Авокадо</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Футомаки -->
  <section class="menu-section">
    <h2 class="section-title">Футомаки</h2>
    <div class="grid">
      <article class="card" data-id="футомаки_с_крабом">
        <div class="photo" style="background-image:url('Foto/Shushi-4.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Футомаки с Крабом</span><span class="label-jp"><span class="scroll-text">クラブ太巻き</span></span></h3>
          <p class="ingredients">Огурец · Авокадо · Сыр Philadelphia · Крабовое мясо</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="футомаки_с_креветкой">
        <div class="photo" style="background-image:url('Foto/Shushi-3.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Футомаки с креветкой</span><span class="label-jp"><span class="scroll-text">エビ太巻き</span></span></h3>
          <p class="ingredients">Огурец · Сыр Philadelphia · Креветка</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Маки -->
  <section class="menu-section">
    <h2 class="section-title">Маки</h2>
    <div class="grid">
      <article class="card" data-id="маки_с_огурцом">
        <div class="photo" style="background-image:url('Foto/Shushi-7.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Маки с огурцом</span><span class="label-jp"><span class="scroll-text">キュウリ</span></span></h3>
          <p class="ingredients">Огурец</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="маки_с_омлетом">
        <div class="photo" style="background-image:url('Foto/Shushi-6.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Маки с омлетом</span><span class="label-jp"><span class="scroll-text">玉子巻</span></span></h3>
          <p class="ingredients">Японский омлет</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Темпура -->
  <section class="menu-section">
    <h2 class="section-title">Темпура</h2>
    <div class="grid">
      <article class="card" data-id="темпура_с_крабом">
        <div class="photo" style="background-image:url('Foto/Shushi-22.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Темпура с крабом</span><span class="label-jp"><span class="scroll-text">カニ天ぷら</span></span></h3>
          <p class="ingredients">Огурец · Сыр Philadelphia · Крабовое мясо</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="темпура_с_курицей">
        <div class="photo" style="background-image:url('Foto/Shushi-13.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Темпура с курицей</span><span class="label-jp"><span class="scroll-text">チキン天ぷら</span></span></h3>
          <p class="ingredients">Огурец · Паприка · Сыр Philadelphia · Курица</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Запечённые -->
  <section class="menu-section">
    <h2 class="section-title">Запечённые</h2>
    <div class="grid">
      <article class="card" data-id="запечённый_ролл_нико">
        <div class="photo" style="background-image:url('Foto/Shushi-19.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
          </div>
        <div class="body">
          <h3 class="title"><span class="name">Запечённый Ролл «Нико»</span><span class="label-jp"><span class="scroll-text">ニコ焼きロール</span></span></h3>
          <p class="ingredients">Огурец · Сыр Philadelphia · Лосось, Крабовое мясо · Масаго</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="запечённый_ролл_салмон">
        <div class="photo" style="background-image:url('Foto/Shushi-18.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Запечённый Ролл «Сaлмон»</span><span class="label-jp"><span class="scroll-text">サーモン焼きロール</span></span></h3>
          <p class="ingredients">Авокадо · Сыр Philadelphia · Лосось</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Нигири -->
  <section class="menu-section">
    <h2 class="section-title">Нигири</h2>
    <div class="grid">
      <article class="card" data-id="нигири_с_креветкой">
        <div class="photo" style="background-image:url('Foto/Shushi-27.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Нигири с креветкой</span><span class="label-jp"><span class="scroll-text">海老握り</span></span></h3>
          <p class="ingredients">Креветка</p>
          <div class="bottom"><div class="note">2 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="нигири_с_угрём">
        <div class="photo" style="background-image:url('Foto/Shushi-28.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Нигири с угрём</span><span class="label-jp"><span class="scroll-text">鰻握り</span></span></h3>
          <p class="ingredients">Угорь</p>
          <div class="bottom"><div class="note">2 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Наборы -->
<section class="menu-section">
  <h2 class="section-title">Наборы</h2>
  <div class="grid">
    <article class="card" data-id="классика">
      <div class="photo" style="background-image:url('Foto/');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Классика</span><span class="label-jp"><span class="scroll-text">クラシック</span></span></h3>
        <p class="ingredients">Филадельфия · Снежный краб · Маки с огурцом</p>
        <div class="bottom"><div class="note">24 шт</div><div class="price"></div></div>
      </div>
    </article>

    <article class="card" data-id="премиум">
      <div class="photo" style="background-image:url('Foto/');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Премиум</span><span class="label-jp"><span class="scroll-text">プレミアム</span></span></h3>
        <p class="ingredients">Филадельфия · Аляска · Нигири с угрём · Нигири с креветкой</p>
        <div class="bottom"><div class="note">20 шт</div><div class="price"></div></div>
      </div>
    </article>
  </div>
</section>

<!-- Раздел: Дополнительно -->
<section class="menu-section">
  <h2 class="section-title">Дополнительно</h2>
  <div class="grid">
    <article class="card" data-id="соевый_соус">
      <div class="photo" style="background-image:url('Foto/');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Соевый соус</span><span class="label-jp"><span class="scroll-text">醤油</span></span></h3>
        <p class="ingredients"></p>
        <div class="bottom"><div class="note">50 мл</div><div class="price"></div></div>
      </div>
    </article>

    <article class="card" data-id="имбирь">
      <div class="photo" style="background-image:url('Foto/Shushi-31.jpg');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Имбирь</span><span class="label-jp"><span class="scroll-text">生姜</span></span></h3>
        <p class="ingredients"></p>
        <div class="bottom"><div class="note">50 г</div><div class="price"></div></div>
      </div>
    </article>

    <article class="card" data-id="вакаме">
      <div class="photo" style="background-image:url('Foto/Shushi-30.jpg');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Вакаме</span><span class="label-jp"><span class="scroll-text">ワカメ</span></span></h3>
        <p class="ingredients"></p>
        <div class="bottom"><div class="note">50 г</div><div class="price"></div></div>
      </div>
    </article>
  </div>
</section>



  <div class="menu-bottom-space"></div>
</main>

<footer class="site-footer">
  <div class="footer-divider"></div>

  <div class="footer-content">
    <div class="footer-left">
      <p><strong>SushiX OÜ</strong></p>
    </div>

    <div class="footer-center">
      <ul class="contacts-list">
        <li>Телефон: <a href="tel:+1234567890">+1 234 567 890</a></li>
        <li>Email: <a href="mailto:info@sushix.ee">info@sushix.ee</a></li>
      </ul>
    </div>

    <div class="footer-right">
      <ul class="social-list">
        <li><a href="https://www.instagram.com/sushix.eesti/" target="_blank">Instagram</a></li>
        <li><a href="https://facebook.com/yourpage" target="_blank">Facebook</a></li>
      </ul>
    </div>
  </div>

  <div class="footer-bottom">
    <p>© 2026 SushiX. Все права защищены.</p>
  </div>
</footer>



</div>

<div class="toast" id="toast">Товар добавлен в корзину</div>
<div class="floating-cart">
  <img src="Foto/cart.png" alt="Корзина">
  <span>Корзина</span>
</div>

<div id="toast" class="toast">
  <div class="toast-text"></div>
</div>



<!-- Fullscreen корзина -->
<div id="cartFullscreen" class="cart-fullscreen" aria-hidden="true">
  <div class="cart-inner">
    <div class="cart-header">
      <h2 class="cart-title">Корзина</h2>
      <div id="free-delivery-info" class="free-delivery-info"></div>

      <button id="closeCart" class="cart-close" aria-label="Закрыть корзину">&times;</button>
    </div>

    <div class="cart-body">
      <!-- Список товаров -->
      <div class="cart-items" role="list"></div>

      <!-- Итоги -->
      <div class="cart-summary">
        <div class="summary-row"><span>Товары</span><span class="subtotal-price">0.00 €</span></div>
        <div class="summary-row"><span>Доставка</span><span class="delivery-price">0.00 €</span></div>
        <div class="summary-row"><span>Скидка</span><span class="discount-price">0.00 €</span></div>
<!-- Кнопка показать поле промокода -->
<button id="showPromoBtn" class="btn-primary promo-toggle-btn">Ввести промокод</button>


<!-- Поле для ввода промокода (изначально скрыто) -->
<div class="promo-code-box" style="display:none;">
  <div class="checkout-form input"><input id="promoInput" type="text" placeholder="Промокод"></div>
 
  
  <div class="promo-actions">
    <button id="applyPromo" class="btn-primary">Применить</button>
    <button id="cancelPromo" class="btn-ghost">Отмена</button>
  </div>

  <div id="promoMessage" class="promo-message"></div>
</div>
        <div class="summary-divider"></div>
        <div class="summary-total"><span>Итого</span><span class="total-price">0.00 €</span></div>
      </div>

      <!-- Форма оформления -->
      <div class="checkout-card">
        <h3>Оформление заказа</h3>
        <form id="checkoutForm" class="checkout-form" onsubmit="return false;">
          <input name="name" type="text" placeholder="Имя *" autocomplete="name" />
          <input name="phone" type="tel" pattern="[+\d]*" placeholder="Номер телефона *" autocomplete="tel" required/>
          <input name="email" type="email" placeholder="Почта *" autocomplete="email" />
          <select name="payment">
            <option value="" disabled selected>Способ оплаты *</option>
            <option>Наличные</option>
            <option>Карта онлайн</option>
          </select>
          <select name="method">
            <option value="" disabled selected>Способ получения *</option>
            <option>Самовывоз</option>
            <option>Доставка</option>
          </select>

<div id="deliveryFields" style="display:none; margin-top:10px;">
  <p class="deliveryNote">NB! Доставка осуществляется только по Tiskre Küla</p>  
  <button type="button" class="btn-ghost" id="chooseDateBtn">Выбрать дату *</button>
  <div id="deliveryCalendar" class="custom-calendar" style="display:none;"></div>

<select id="deliveryTime"></select>

<input type="text" id="deliveryAddress" placeholder="Адрес доставки *" class="checkout-form">

<div class="form-group comment-group">
  <textarea id="orderComment" name="comment" placeholder="Комментарий (необязательно)" rows="3"></textarea>
</div>





</div>






          <div class="checkout-actions">
            <button id="placeOrder" class="btn-primary" type="button">Оформить заказ</button>
            <button id="clearCartBtn" class="btn-ghost" type="button">Очистить корзину</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="cartBackdrop" class="cart-backdrop"></div>





<script>
const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=0&single=true&output=csv';

function updateCartUI() {
  renderCart();
  updateDeliveryTimes();
}

// ===== Плавающий фильтр =====
const mainBar = document.getElementById('menuFilters');
const floatingBar = document.getElementById('menuFiltersFloating');

function shouldShowFloatingBar() {
  if (window.innerWidth > 767) return true;
  const firstSection = document.querySelector('.menu-section .grid');
  if (!firstSection) return false;
  const cards = Array.from(firstSection.children);
  if (cards.length < 2) return false;
  const rect1 = cards[0].getBoundingClientRect();
  const rect2 = cards[1].getBoundingClientRect();
  return rect1.top === rect2.top;
}

window.addEventListener('scroll', () => {
  const mainTop = mainBar.getBoundingClientRect().top;
  if (!shouldShowFloatingBar() || mainTop > 0) floatingBar.classList.remove('show');
  else floatingBar.classList.add('show');

  updateActiveFilter();
});

window.addEventListener('resize', () => {
  if (!shouldShowFloatingBar()) floatingBar.classList.remove('show');
});

// ===== Обновление меню из Google Sheets =====
async function updateMenuFromSheet() {
  try {
    const res = await fetch(sheetUrl);
    const text = await res.text();
    const rows = text.trim().split('\n').map(r => r.split(','));
    const headers = rows[0].map(h => h.trim());
    const data = rows.slice(1).map(r => Object.fromEntries(r.map((v, i) => [headers[i], v.trim()])));

    let ordersEnabled = true;

    for (let item of data) {
      if(item['id'] && item['id'].toLowerCase() === 'orders_enabled') {
        ordersEnabled = (item['Доступно'] || item['Цена'] || item['Цена_со_скидкой'] || item['Скидка'] || item['Скрыто'] || 'yes').toLowerCase() === 'yes';
        document.getElementById('orders-disabled-note').style.display = ordersEnabled ? 'none' : 'block';
        if (placeOrderBtn) {
        placeOrderBtn.style.display = ordersEnabled ? 'inline-block' : 'none';
    }

    continue;
}


// НАСТРОЙКИ ДОСТАВКИ ИЗ ТАБЛИЦЫ
if (item['id'] && item['id'].toLowerCase() === 'delivery_cost') {
    DELIVERY_COST = parseFloat(item['Цена']?.replace(',', '.')) || 0;
    continue;
}

if (item['id'] && item['id'].toLowerCase() === 'free_delivery_limit') {
    FREE_DELIVERY_LIMIT = parseFloat(item['Цена']?.replace(',', '.')) || 0;
    continue;
}



      const el = document.querySelector(`.card[data-id="${item['id']}"]`);
      if (!el) continue;

      const priceEl = el.querySelector('.price');
      const overlay = el.querySelector('.overlay-unavailable');
      const cartIcon = el.querySelector('.cart-icon');

      const available = (item['Доступно'] || '').toLowerCase() === 'true';
      const hidden = (item['Скрыто'] || '').toLowerCase() === 'true';
      el.style.display = hidden ? 'none' : '';

      // Цена и скидка
      const basePrice = parseFloat(item['Цена'].replace(',', '.')) || 0;
      const discountPrice = parseFloat(item['Цена_со_скидкой']?.replace(',', '.')) || 0;
      const discountPercent = item['Скидка'] ? parseInt(item['Скидка']) : 0;
      let priceHTML = '';

      if (discountPrice > 0 && discountPrice < basePrice) {
        const formattedOld = basePrice.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formattedNew = discountPrice.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        priceHTML = `<span class="discount">-${discountPercent}%</span> <span class="old-price">${formattedOld} €</span> <span class="new-price">${formattedNew} €</span>`;
        el.classList.add('has-discount');
        if (!el.querySelector('.discount-badge')) {
          const badge = document.createElement('div');
          badge.className = 'discount-badge';
          badge.textContent = 'Скидка';
          el.querySelector('.photo').appendChild(badge);
        }
      } else {
        const formattedBase = basePrice.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        priceHTML = `${formattedBase} €`;
        el.classList.remove('has-discount');
      }
      if(priceEl) priceEl.innerHTML = priceHTML;

      // Доступность
      if (!available) {
        el.classList.add('unavailable');
        if(overlay) overlay.textContent = 'Временно недоступно';
        if(cartIcon) cartIcon.classList.add('hidden');
      } else {
        el.classList.remove('unavailable');
        if(overlay) overlay.textContent = '';
        if(cartIcon) ordersEnabled ? cartIcon.classList.remove('hidden') : cartIcon.classList.add('hidden');
      }
    }

    // Корзина
document.querySelectorAll('.cart-icon').forEach(icon => {
  icon.addEventListener('click', () => {
    const card = icon.closest('.card');
    addToCart(card);
  });
});

    document.querySelector('.floating-cart').onclick = () => {
  if(!ordersEnabled) showToast('Заказы временно не принимаются', true);
  // иначе ничего не делаем, чтобы надпись не появлялась
};


    // Специальные предложения
    updateSpecialOffersSection();

updateCartUI();



  } catch (e) { console.error('Ошибка загрузки меню', e); }
}

// ===== Специальные предложения =====
function updateSpecialOffersSection() {
  const specialGrid = document.querySelector('#specialOffers .grid');
  const specialSection = document.getElementById('specialOffers');
  const buttons = document.querySelectorAll('#menuFilters button, #menuFiltersFloating button');

  if (!specialGrid || !specialSection) return;
  specialGrid.innerHTML = '';
  const discountedCards = document.querySelectorAll('.card.has-discount');

  if (discountedCards.length > 0) {
    discountedCards.forEach(card => {
      const clone = card.cloneNode(true);
      specialGrid.appendChild(clone);
    });

    specialSection.style.display = 'block';
    specialSection.classList.add('special-offers-section');

    buttons.forEach(btn => { 
      if(btn.textContent.trim().toLowerCase() === 'предложения') btn.style.display='inline-block'; 
    });

    // Навешиваем корзину на клонированные карточки
specialGrid.querySelectorAll('.cart-icon').forEach(icon => {
  icon.onclick = () => {
    const card = icon.closest('.card');
    addToCart(card); // теперь товары добавляются в корзину с учётом количества
  }
});


  } else {
    specialSection.style.display = 'none';
    buttons.forEach(btn => { 
      if(btn.textContent.trim().toLowerCase() === 'предложения') btn.style.display='none'; 
    });
  }
}

// ===== Анимация карточек =====
function animateCards() {
  const sections = document.querySelectorAll('.menu-section');
  sections.forEach((section, secIndex) => {
    const cards = section.querySelectorAll('.card');
    cards.forEach((card, i) => {
      card.style.opacity = 0;
      card.style.transform = 'translateY(20px) scale(0.95)';
      setTimeout(() => {
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        card.style.opacity = 1;
        card.style.transform = 'translateY(0) scale(1)';
      }, i * 60 + secIndex * 120);
    });
    const title = section.querySelector('.section-title');
    if (title) {
      title.style.opacity = 0;
      title.style.transform = 'translateY(20px)';
      setTimeout(() => {
        title.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        title.style.opacity = 1;
        title.style.transform = 'translateY(0)';
      }, cards.length * 60 + secIndex * 130);
    }
    setTimeout(() => section.classList.add('show'), cards.length * 60 + secIndex * 150);
  });
  mainBar.classList.add('show');
}

// ===== Активный фильтр =====
const sections = document.querySelectorAll('.menu-section');
const buttons = document.querySelectorAll('#menuFilters button, #menuFiltersFloating button');

function updateActiveFilter() {
  const scrollTop = window.scrollY + 120; // небольшой отступ сверху
  let currentSection = null;

    // Если пользователь в самом верху страницы — активируем первый раздел
  if (window.scrollY < 50) {
    const firstSection = sections[0];
    if (firstSection) {
      const firstName = firstSection.querySelector('.section-title')?.textContent.trim().toLowerCase();
      buttons.forEach(btn => {
        if (btn.textContent.trim().toLowerCase() === firstName) btn.classList.add('active-filter');
        else btn.classList.remove('active-filter');
      });
    }
    return; // чтобы не выполнялась остальная часть
  }


  const specialSection = document.querySelector('.special-offers-section');
  if (specialSection) {
    const sectionTop = specialSection.offsetTop;
    const sectionBottom = sectionTop + specialSection.offsetHeight;
    if (scrollTop >= sectionTop && scrollTop < sectionTop + specialSection.offsetHeight / 2) {
      currentSection = specialSection;
    }
  }

  if (!currentSection) {
    sections.forEach(sec => {
      if (sec.classList.contains('special-offers-section')) return;
      const top = sec.offsetTop;
      const bottom = top + sec.offsetHeight;
      if (scrollTop >= top && scrollTop < bottom) {
        currentSection = sec;
      }
    });
  }

  if (!currentSection) return;
  const sectionName = currentSection.querySelector('.section-title')?.textContent.trim().toLowerCase();
  buttons.forEach(btn => {
    if (btn.textContent.trim().toLowerCase() === sectionName) btn.classList.add('active-filter');
    else btn.classList.remove('active-filter');
  });
}

// ===== Плавный скролл по кнопке =====
buttons.forEach(btn => {
  btn.addEventListener('click', e => {
    const text = e.target.textContent.trim().toLowerCase();
    const targetSection = Array.from(sections).find(sec => {
      const title = sec.querySelector('.section-title');
      return title && title.textContent.trim().toLowerCase() === text;
    });
    if (targetSection) {
      window.scrollTo({
        top: targetSection.offsetTop - 80,
        behavior: 'smooth'
      });
    }
  });
});

// ===== Инициализация =====
(async () => {
  await updateMenuFromSheet();   // ждем загрузку меню
  updateActiveFilter();          // обновляем активный фильтр
  setTimeout(() => {
    animateCards();              // запускаем анимацию
  }, 250);
  
})();


// ===== Выбор шапочки =====
const rollSelectWrappers = document.querySelectorAll('.roll-select-wrapper');

rollSelectWrappers.forEach(wrapper => {
  const btn = wrapper.querySelector('.select-btn');
  const dropdown = wrapper.querySelector('.select-dropdown');
  const arrow = wrapper.querySelector('.arrow');

  // Проверяем, есть ли "Сырная шапочка" в списке
  let defaultTopping = 'Сырная шапочка';
  let exists = Array.from(dropdown.querySelectorAll('li')).some(li => li.textContent.trim() === defaultTopping);
  if (!exists) {
    const li = document.createElement('li');
    li.textContent = defaultTopping;
    dropdown.prepend(li);
  }

  // Устанавливаем значение по умолчанию
  btn.firstChild.textContent = defaultTopping + ' ';

  // Открытие/закрытие списка
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    dropdown.classList.toggle('show');
    arrow.style.transform = dropdown.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
  });

  // Выбор элемента из списка
  dropdown.querySelectorAll('li').forEach(item => {
    item.addEventListener('click', () => {
      btn.firstChild.textContent = item.textContent + ' ';
      dropdown.classList.remove('show');
      arrow.style.transform = 'rotate(0deg)';
    });
  });

  // Закрытие при клике вне области
  document.addEventListener('click', (e) => {
    if (!wrapper.contains(e.target)) {
      dropdown.classList.remove('show');
      arrow.style.transform = 'rotate(0deg)';
    }
  });
});








// ===== НАСТРОЙКИ =====
const cartItemsContainer = document.querySelector('.cart-items');
const subtotalEl = document.querySelector('.subtotal-price');
const deliveryEl = document.querySelector('.delivery-price');
const discountEl = document.querySelector('.discount-price');
const totalEl = document.querySelector('.total-price');
const cartCountEl = document.querySelector('.cart-count');
const cartFullscreenEl = document.getElementById('cartFullscreen');
const cartBackdrop = document.getElementById('cartBackdrop');
const closeBtn = document.getElementById('closeCart');
const placeOrderBtn = document.getElementById('placeOrder');
const clearCartBtn = document.getElementById('clearCartBtn');
const checkoutForm = document.getElementById('checkoutForm');
const phoneInput = checkoutForm?.querySelector('input[name="phone"]');


const paymentSelect = checkoutForm?.payment;

paymentSelect?.addEventListener('change', () => {
    if (paymentSelect.value.toLowerCase() === 'карта онлайн') {
        placeOrderBtn.textContent = 'Перейти к оплате';
    } else {
        placeOrderBtn.textContent = 'Оформить заказ';
    }
});




if(phoneInput){
    phoneInput.addEventListener('input', () => {
        phoneInput.value = phoneInput.value.replace(/[^+\d]/g,'');
    });
}

let DELIVERY_COST = 5.00;
let FREE_DELIVERY_LIMIT = 50.00;
const ITEM_LIMIT = 20;
const cart = new Map();


// ===== LOCALSTORAGE =====
function saveCart(){ localStorage.setItem('cart', JSON.stringify(Object.fromEntries(cart))); }
function loadCart(){
    const data = localStorage.getItem('cart');
    if(data){
        const obj = JSON.parse(data);
        cart.clear();
        for(const [id,item] of Object.entries(obj)){
            cart.set(id,item);
        }
    }
}

// ===== TOAST =====
function showToast(msg, isRed = false, duration = 2500) {
    const toast = document.getElementById('toast');
    if (!toast) return;

    toast.innerHTML = msg;
    toast.className = 'toast show ' + (isRed ? 'red' : 'white');

    // очищаем предыдущий таймер, если был
    if (toast._timer) {
        clearTimeout(toast._timer);
    }

    toast._timer = setTimeout(() => {
        toast.classList.remove('show');
    }, duration);
}


// ===== ESCAPE HTML =====
function escapeHtml(str){ return String(str).replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

// ===== ДОБАВЛЕНИЕ В КОРЗИНУ =====
function addToCart(card){
    const ordersEnabled = document.getElementById('orders-disabled-note')?.style.display==='none';
    if(!ordersEnabled) return showToast('Заказы временно не принимаются', true);

    const id = card.dataset.id || card.querySelector('.title')?.textContent.trim();
    const name = card.querySelector('.title .name')?.textContent.trim() || 'Товар';
    const priceEl = card.querySelector('.price');
    const newPriceEl = priceEl?.querySelector('.new-price');
    const oldPriceEl = priceEl?.querySelector('.old-price');

    const unitPrice = newPriceEl
        ? parseFloat(newPriceEl.textContent.replace(/[^\d.,]/g,'').replace(',','.'))||0
        : parseFloat(priceEl?.textContent.replace(/[^\d.,]/g,'').replace(',','.'))||0;
    const originalPrice = oldPriceEl
        ? parseFloat(oldPriceEl.textContent.replace(/[^\d.,]/g,'').replace(',','.'))||unitPrice
        : unitPrice;

    if(cart.has(id)){
        const item = cart.get(id);
        if(item.qty<ITEM_LIMIT){
            item.qty++;
            cart.set(id,item);
            showToast('Товар добавлен в корзину');
        } else showToast(`Максимум ${ITEM_LIMIT} штук`, true);
    } else {
        cart.set(id,{name,unitPrice,originalPrice,qty:1});
        showToast('Товар добавлен в корзину');
    }

    saveCart();
    updateCartUI();
}

// ===== ОБНОВЛЕНИЕ ПРИ СМЕНЕ СПОСОБА ПОЛУЧЕНИЯ =====
checkoutForm?.method?.addEventListener('change', renderCart);


// ===== OPEN/CLOSE =====
function openCart(){ cartFullscreenEl?.setAttribute('aria-hidden','false'); cartBackdrop?.classList.add('show'); }
function closeCart(){ cartFullscreenEl?.setAttribute('aria-hidden','true'); cartBackdrop?.classList.remove('show'); }
document.querySelector('.floating-cart')?.addEventListener('click',openCart);
closeBtn?.addEventListener('click',closeCart);
cartBackdrop?.addEventListener('click',closeCart);

// ===== ОЧИСТКА =====
clearCartBtn?.addEventListener('click',()=>{
    cart.clear();
    saveCart();
    showToast('Корзина очищена');
    updateCartUI();
});

// ====== Сохранение данных формы ======
if (checkoutForm) {
  // Загрузка при старте
  const savedForm = localStorage.getItem('checkoutFormData');
  if (savedForm) {
    const data = JSON.parse(savedForm);
    for (const key in data) {
      if (checkoutForm[key]) checkoutForm[key].value = data[key];
    }
  }

const addressInput = document.getElementById('deliveryAddress');

// загрузка сохранённого адреса
if (addressInput) {
    const savedAddress = localStorage.getItem('deliveryAddress');
    if (savedAddress) {
        addressInput.value = savedAddress;
    }

    // сохраняем при изменении
    addressInput.addEventListener('input', () => {
        localStorage.setItem('deliveryAddress', addressInput.value.trim());
    });
}


  // Сохраняем при изменении любого поля
  checkoutForm.addEventListener('input', () => {
    const data = {};
    Array.from(checkoutForm.elements).forEach(el => {
      if (el.name) data[el.name] = el.value;
    });
    localStorage.setItem('checkoutFormData', JSON.stringify(data));
  });
}

// ====== Очистка формы при оформлении заказа ======
placeOrderBtn?.addEventListener('click', () => {
    if (!checkoutForm) return;
    

    const name = checkoutForm.name.value.trim();
    const phone = checkoutForm.phone.value.trim();
    const email = checkoutForm.email.value.trim();
    const payment = checkoutForm.payment.value;
    const method = checkoutForm.method.value.toLowerCase();
    const comment = checkoutForm.comment?.value.trim() || '';

    
    // ===== проверка корзины =====
    
 // ===== проверка основных полей с подсветкой =====
let hasError = false;

const fields = [
  {el: checkoutForm.name, required: true},
  {el: checkoutForm.phone, required: true},
  {el: checkoutForm.email, required: true},
  {el: checkoutForm.payment, required: true},
  {el: checkoutForm.method, required: true},
  {el: document.getElementById('deliveryTime'), required: true},
  {el: document.getElementById('chooseDateBtn'), required: true, isBtn: true},
  {el: document.getElementById('deliveryAddress'), required: method === 'доставка'}
];

fields.forEach(f => {
  const value = f.isBtn ? f.el.textContent : f.el.value;
  if (f.required && (!value || (f.isBtn && !value.includes('Дата')))) {
    f.el.classList.add('error');
    hasError = true;
  } else {
    f.el.classList.remove('error');
  }
});

if (cart.size === 0) {
        showToast('В корзине нет товаров', true);
        return;
    }

if (hasError) {
  showToast('Заполните все обязательные поля', true);
  return;
}


    const isDelivery = method === 'доставка';
    const isPickup = method === 'самовывоз';

    const dateBtn = document.getElementById('chooseDateBtn');
    const timeSelect = document.getElementById('deliveryTime');
    const addressInput = document.getElementById('deliveryAddress');

    // ===== проверка даты =====
    if ((isDelivery || isPickup) && (!dateBtn || !dateBtn.textContent.includes('Дата'))) {
        showToast(isDelivery ? 'Заполните все обязательные поля' : 'Заполните все обязательные поля', true);
        return;
    }

    // ===== проверка времени =====
    if ((isDelivery || isPickup) && (!timeSelect || !timeSelect.value)) {
        showToast(isDelivery ? 'Заполните все обязательные поля' : 'Заполните все обязательные поля', true);
        return;
    }

    // ===== проверка адреса для доставки =====
    if (isDelivery && (!addressInput || !addressInput.value.trim())) {
        showToast('Заполните все обязательные поля', true);
        return;
    }

    // ===== проверка суммы =====
    const total = parseFloat(totalEl.textContent);
    if (total <= 0) {
        showToast('Сумма заказа должна быть больше 0 €', true);
        return;
    }



// ===== Логика для оплаты картой =====
if (payment.toLowerCase() === 'карта онлайн') {
    showToast('<strong>Перенаправление к странице оплаты...</strong><br><small>Это может занять до 1 минуты</small>', false, 120000);

const cartData = [];
cart.forEach((item, id) => {
    // Отправляем все товары, включая бесплатные
    cartData.push({
        id,
        name: item.name,
        unitPrice: item.unitPrice > 0 ? item.unitPrice : 0.01, // 1 цент вместо 0
        qty: item.qty,
        promoFree: item.promoFree || false
    });
});


    const delivery = parseFloat(deliveryEl.textContent) || 0;

    // ===== Промокод =====
// ===== Промокод (ТОЛЬКО бизнес-данные) =====
let promoForStripe = null;

if (activePromo) {
  // Проверка минимальной суммы для промокодов min_total_discount
  const subtotalValue = parseFloat(subtotalEl.textContent.replace(/[^\d.]/g, "")) || 0;
  
  if (activePromo.type === 'min_total_discount' && subtotalValue < activePromo.min) {
    promoForStripe = null; // минимальная сумма не достигнута — не отправляем промокод
  } else if (activePromo.type === 'cart_discount') {
    promoForStripe = {
      type: 'cart_discount',
      value: activePromo.value
    };
  } else if (activePromo.type === 'flat_discount' || activePromo.type === 'min_total_discount') {
    promoForStripe = {
      type: activePromo.type,
      value: activePromo.value
    };
  }
}


// Теперь отправляем на сервер
fetch("https://stripe-test-it0r.onrender.com/create-checkout-session", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    cart: cartData,
    delivery,
    promo: promoForStripe   // ← ТОЛЬКО ЭТО
  })
})
.then(res => res.json())
.then(data => {
  if (data.url) {
    window.location.href = data.url;
  } else {
    alert(data.error || "Ошибка создания платежа");
  }
})
.catch(err => alert("Ошибка запроса к серверу: " + err.message));

    return;
}



function updateOrderButtonText() {
    if (!checkoutForm || !placeOrderBtn) return;

    const payment = checkoutForm.payment.value;

    if (payment === 'Карта онлайн') {
        placeOrderBtn.textContent = 'Перейти к оплате';
    } else {
        placeOrderBtn.textContent = 'Оформить заказ';
    }
}



    // ===== оформление заказа =====
    showToast('Заказ принят — спасибо!');
    cart.clear();
    saveCart();
    updateCartUI();

    checkoutForm.reset();
    if (dateBtn) dateBtn.textContent = isDelivery ? 'Выбрать дату доставки' : 'Выбрать дату самовывоза';
    if (timeSelect) timeSelect.value = '';
    if (addressInput) addressInput.value = '';

    localStorage.removeItem('checkoutFormData');
    localStorage.removeItem('deliveryAddress');
    setTimeout(closeCart, 900);
});





// ========================================================
// 1. ЗАГРУЗКА ПРОМОКОДОВ ИЗ GOOGLE SHEETS
// ========================================================
const promoSheetUrl =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=1716078291&single=true&output=csv";

let promoCodes = {}; 
let activePromo = null;

// ===== Сохранение и загрузка промокода =====
function savePromo() {
  if (activePromo) localStorage.setItem('activePromo', JSON.stringify(activePromo));
  else localStorage.removeItem('activePromo');
}

function loadPromo() {
  const data = localStorage.getItem('activePromo');
  if (data) {
    activePromo = JSON.parse(data);
    promoInput.value = activePromo.code || '';
    if (activePromo.type === 'free_item' && activePromo.min > 0) {
      promoMessage.textContent = `Промокод "${activePromo.code}" активен при покупке от ${activePromo.min} €`;
    } else {
      promoMessage.textContent = `Промокод "${activePromo.code}" применён`;
    }
    promoMessage.style.color = 'green';
  }
}


async function loadPromoCodes() {
  try {
    const res = await fetch(promoSheetUrl);
    const csv = await res.text();
    const lines = csv.split("\n").map(l => l.trim());

    promoCodes = {};

    for (let i = 1; i < lines.length; i++) {
      if (!lines[i]) continue;

      const cols = lines[i].split(",");

      const code = cols[0]?.trim().toUpperCase();
      const type = cols[1]?.trim();
      const value = Number(cols[2]) || 0;
      const min = Number(cols[3]) || 0;
      const itemId = cols[4]?.trim();
      const enabled = cols[5]?.trim().toUpperCase() === "YES";

      if (!enabled || !code) continue;

      promoCodes[code] = { type };
      if (value) promoCodes[code].value = value;
      if (min) promoCodes[code].min = min;
      if (itemId) promoCodes[code].itemId = itemId;
    }

    console.log("Промокоды загружены:", promoCodes);
  } catch (err) {
    console.error("Ошибка загрузки промокодов:", err);
  }
}

loadPromoCodes();


// ========================================================
// 2. ЭЛЕМЕНТЫ И UI
// ========================================================
const showPromoBtn = document.getElementById('showPromoBtn');
const promoBox = document.querySelector('.promo-code-box');
const promoInput = document.getElementById('promoInput');
const applyPromoBtn = document.getElementById('applyPromo');
const cancelPromoBtn = document.querySelector('.promo-actions #cancelPromo');
const promoMessage = document.getElementById('promoMessage');

// Показываем поле ввода
showPromoBtn.addEventListener('click', () => {
  promoBox.style.display = 'block';
  showPromoBtn.style.display = 'none';
});

// Заглавные буквы
promoInput.addEventListener('input', () => {
  promoInput.value = promoInput.value.toUpperCase();
});

// Отмена кнопкой "Отмена" (UI)
document.getElementById("cancelPromo").addEventListener("click", () => {
  promoBox.style.display = "none";
  showPromoBtn.style.display = "block";
});


// ========================================================
// 3. ПРИМЕНЕНИЕ ПРОМОКОДА
// ========================================================
applyPromoBtn.addEventListener('click', () => {
  const code = promoInput.value.trim().toUpperCase();
  if (!code) return;

// ===== УДАЛЯЕМ бесплатный товар от предыдущего промокода =====
if (activePromo && activePromo.type === 'free_item') {
    const oldId = activePromo.itemId + '_promo';
    if (cart.has(oldId)) {
        cart.delete(oldId);
        saveCart();
        updateDeliveryTimes();
    }
}


  if (promoCodes[code]) {
    activePromo = promoCodes[code];
    activePromo.code = code;
    savePromo();

    if (activePromo.type === 'free_item', 'min_total_discount' && activePromo.min > 0) {
      promoMessage.textContent = `Промокод "${code}" активен при покупке от ${activePromo.min} €`;
    } else {      
      promoMessage.textContent = `Промокод "${code}" применён`;
    }
    promoMessage.style.color = 'green';
  } else {
    promoMessage.textContent = 'Промокод не найден';
    promoMessage.style.color = 'red';
    activePromo = null;
  }

  updateCartUI();
});



// ========================================================
// 4. ОТМЕНА ПРОМОКОДА (ЛОГИКА)
// ========================================================
cancelPromoBtn.addEventListener('click', () => {
  // Удаляем бесплатный товар если был
  if (activePromo && activePromo.type === 'free_item') {
    const id = activePromo.itemId + '_promo';
    if (cart.has(id)) cart.delete(id);
  }

  activePromo = null;
  promoInput.value = '';
  promoMessage.textContent = '';

  updateCartUI();
});


// ========================================================
// 5. ОСНОВНАЯ ЛОГИКА ПРИ РЕНДЕРЕ КОРЗИНЫ
// ========================================================
function renderCart() {
  if (!cartItemsContainer) return;
  cartItemsContainer.innerHTML = '';

// ===== Обновляем цены товаров по текущим карточкам =====
cart.forEach((item, id) => {
    // Пропускаем бесплатные позиции по промокоду
    if (item.unitPrice === 0 && item.promoFree) return;

    const cardEl = document.querySelector(`.card[data-id="${id}"]`);
    if (!cardEl) return;

    const priceEl = cardEl.querySelector('.price');
    const newPriceEl = priceEl?.querySelector('.new-price');
    const oldPriceEl = priceEl?.querySelector('.old-price');

    const currentUnitPrice = newPriceEl
        ? parseFloat(newPriceEl.textContent.replace(/[^\d.,]/g,'').replace(',','.')) || 0
        : parseFloat(priceEl?.textContent.replace(/[^\d.,]/g,'').replace(',','.')) || 0;

    const currentOriginalPrice = oldPriceEl
        ? parseFloat(oldPriceEl.textContent.replace(/[^\d.,]/g,'').replace(',','.')) || currentUnitPrice
        : currentUnitPrice;

    // Обновляем только если цена изменилась
    if(item.unitPrice !== currentUnitPrice || item.originalPrice !== currentOriginalPrice) {
        item.unitPrice = currentUnitPrice;
        item.originalPrice = currentOriginalPrice;
        cart.set(id, item);
    }
});


const freeInfo = document.getElementById('free-delivery-info');
if (FREE_DELIVERY_LIMIT > 0) {
    freeInfo.style.display = 'block';
    freeInfo.textContent = `Бесплатная доставка при покупке на сумму ${FREE_DELIVERY_LIMIT} €`;
} else {
    freeInfo.style.display = 'none';
}



  let subtotal = 0;
  cart.forEach((item, id) => subtotal += item.unitPrice * item.qty);


  // ======= ОБРАБОТКА БЕСПЛАТНОГО ТОВАРА =======
  if (activePromo && activePromo.type === 'free_item') {
    const promoId = activePromo.itemId + "_promo";
    const exists = cart.get(promoId);

    // Добавляем только если сумма достаточная и товара нет
    if (subtotal >= (activePromo.min || 0) && !exists) {
      const cardEl = document.querySelector(`.card[data-id="${activePromo.itemId}"]`);
      if (cardEl) {
        const name = cardEl.querySelector('.title .name')?.textContent.trim() || 'Товар';

        cart.set(promoId, {
          name,
          unitPrice: 0,
          originalPrice: 0,
          qty: 1,
          promoFree: true
        });
      }
    }

    // Удаляем если сумма стала ниже минимума
    if (subtotal < (activePromo.min || 0) && exists) {
      cart.delete(promoId);
    }
  }


  // ======= РЕНДЕР ТОВАРОВ =======
  cart.forEach((item, id) => {
    const lineTotal = item.unitPrice * item.qty;

    const el = document.createElement('div');
    el.className = 'cart-item';
    el.dataset.id = id;

    el.innerHTML = `
      <div class="name">${escapeHtml(item.name)}</div>
      <div class="unit">
        ${item.unitPrice.toFixed(2)} €
        ${item.originalPrice && item.originalPrice > item.unitPrice ? `<span class="old-price">${item.originalPrice.toFixed(2)} €</span>` : ''}
      </div>
      <div class="qty-wrap">
        <button class="qty-btn btn-decr">−</button>
        <div class="qty-value">${item.qty}</div>
        <button class="qty-btn btn-incr">+</button>
      </div>
      <div class="line-total">${lineTotal.toFixed(2)} €</div>
      <button class="remove-btn">×</button>
    `;

    const incr = el.querySelector('.btn-incr');
    const decr = el.querySelector('.btn-decr');
    const removeBtn = el.querySelector('.remove-btn');

    // + кнопка
    incr.addEventListener('click', () => {

    if (item.unitPrice === 0) {
        showToast('Бесплатную позицию можно добавить только один раз', true);
        return;
    }

    if (item.qty >= ITEM_LIMIT) {
        showToast(`Максимум ${ITEM_LIMIT} штук`, true);
        return;
    }
      if (item.qty < ITEM_LIMIT) item.qty++;
      cart.set(id, item);
      updateCartUI();
    });

    // - кнопка
    decr.addEventListener('click', () => {
      if (item.qty > 1) item.qty--;
      else cart.delete(id);
      updateCartUI();
    });

    // Удаление
    removeBtn.addEventListener('click', () => {
  if (item.promoFree) {
    return;
  }
  cart.delete(id);
            saveCart();
            updateCartUI();
        });

        cartItemsContainer.appendChild(el);
    });


  // ========================================================
  // 6. СКИДКИ, ДОСТАВКА, ИТОГИ
  // ========================================================

const checkoutForm = document.getElementById('checkoutForm');
const methodSelect = checkoutForm?.method;
const deliveryFields = document.getElementById('deliveryFields');
const deliveryNote = document.querySelector('.deliveryNote');
const chooseDateBtn = document.getElementById('chooseDateBtn');
const deliveryCalendar = document.getElementById('deliveryCalendar');
const deliveryTime = document.getElementById('deliveryTime');
const deliveryAddress = document.getElementById('deliveryAddress');

// ===== ССЫЛКИ НА GOOGLE SHEETS =====
const deliveryTimesSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=1115998539&single=true&output=csv";
const minHoursSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=669184474&single=true&output=csv";

// ===== Данные =====
let deliveryTimesByDate = {}; // ключ: "дд.мм.гггг|метод"
let minHoursRanges = [];      // массив объектов { maxItems: число или null, hours: число }

// ===== ЗАГРУЗКА МИН. ЧАСОВ ИЗ GOOGLE SHEETS =====
async function loadMinHours() {
    try {
        const res = await fetch(minHoursSheetUrl);
        const csv = await res.text();
        const lines = csv.split("\n").map(l => l.trim());

        minHoursRanges = [];
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i]) continue;
            const [maxItemsStr, hoursStr] = lines[i].split(",");
            const maxItems = maxItemsStr ? Number(maxItemsStr.trim()) : null;
            const hours = Number(hoursStr.trim());
            if (!isNaN(hours)) minHoursRanges.push({ maxItems, hours });
        }
    } catch (err) {
        console.error("Ошибка загрузки мин. часов из таблицы", err);
    }
}

// ===== ЗАГРУЗКА ВРЕМЕНИ ДОСТАВКИ ИЗ GOOGLE SHEETS =====
async function loadDeliveryTimes() {
    try {
        const res = await fetch(deliveryTimesSheetUrl);
        const csv = await res.text();
        const lines = csv.split("\n").map(l => l.trim());

        deliveryTimesByDate = {};

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i]) continue;
            const [dateStr, method, time, active] = lines[i].split(",");
            if (!active || active.trim().toUpperCase() !== "YES") continue;
            if (!dateStr || !method || !time) continue;

            // Проверяем диапазон дат
            if (dateStr.includes("-")) {
                const [startStr, endStr] = dateStr.split("-").map(s => s.trim());
                const [startDay, startMonth, startYear] = startStr.split(".").map(Number);
                const [endDay, endMonth, endYear] = endStr.split(".").map(Number);

                let current = new Date(startYear, startMonth - 1, startDay);
                const end = new Date(endYear, endMonth - 1, endDay);

                while (current <= end) {
                    const day = current.getDate().toString().padStart(2, "0");
                    const month = (current.getMonth() + 1).toString().padStart(2, "0");
                    const year = current.getFullYear();
                    const formatted = `${day}.${month}.${year}`;

                    const key = `${formatted}|${method.trim().toLowerCase()}`;
                    if (!deliveryTimesByDate[key]) deliveryTimesByDate[key] = [];
                    deliveryTimesByDate[key].push(time.trim());

                    current.setDate(current.getDate() + 1);
                }
            } else {
                const key = `${dateStr.trim()}|${method.trim().toLowerCase()}`;
                if (!deliveryTimesByDate[key]) deliveryTimesByDate[key] = [];
                deliveryTimesByDate[key].push(time.trim());
            }
        }

        updateDeliveryTimes(); // первый рендер
    } catch (err) {
        console.error("Ошибка загрузки времени доставки", err);
    }
}

// ===== ФИЛЬТРАЦИЯ СЛОТОВ ПО МИН. ЧАСАМ =====
function filterDeliveryTimes(times) {
    if (!selectedDate) return [];

    const now = new Date();

    // считаем общее количество товаров в корзине
    let totalItems = 0;
    cart.forEach(i => totalItems += i.qty);

    // ищем нужный диапазон
    let minHours = 0;
    for (const range of minHoursRanges) {
        if (range.maxItems === null || totalItems <= range.maxItems) {
            minHours = range.hours;
            break;
        }
    }

    const [day, month, year] = selectedDate.split(".").map(Number);

    return times.filter(t => {
        const [startTime] = t.split("–");
        const [hours, minutes] = startTime.split(":").map(Number);
        const slotDate = new Date(year, month - 1, day, hours, minutes);
        const diffHours = (slotDate - now) / (1000 * 60 * 60);
        return diffHours >= minHours;
    });
}

// ===== ОБНОВЛЕНИЕ ВРЕМЕНИ В SELECT =====
function updateDeliveryTimes() {
    if (!deliveryTime) return;

    const method = methodSelect?.value?.toLowerCase();
    if (!method) return;

    deliveryTime.innerHTML = "";

    // placeholder
    const placeholderOption = document.createElement('option');
    placeholderOption.value = "";
    placeholderOption.textContent = "Выбрать время *";
    placeholderOption.disabled = true;
    placeholderOption.selected = true;
    deliveryTime.appendChild(placeholderOption);

    if (!selectedDate) return;

    const key = `${selectedDate}|${method}`;
    let times = deliveryTimesByDate[key] || [];

    // фильтруем прошедшие слоты и по мин. часам
    times = filterDeliveryTimes(times);

    if (times.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "Нет доступного времени";
        option.disabled = true;
        deliveryTime.appendChild(option);

        

        return;
    }

    times.forEach(t => {
        const optionEl = document.createElement('option');
        optionEl.value = t;
        optionEl.textContent = t;
        deliveryTime.appendChild(optionEl);
    });
}

// ===== ОБНОВЛЕНИЕ ПРИ СМЕНЕ МЕТОДА =====
methodSelect?.addEventListener('change', updateDeliveryTimes);

// ===== ЗАГРУЗКА ПРИ СТАРТЕ =====
Promise.all([loadMinHours(), loadDeliveryTimes()]);







let selectedDate = null;
let blockedDates = new Set();
let blockedWeekday = false;
let blockedWeekend = false;

// ===== ЗАГРУЗКА GOOGLE SHEET =====
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=425843351&single=true&output=csv";

async function loadBlockedDates() {
  try {
    const res = await fetch(sheetUrl);
    const csv = await res.text();
    const lines = csv.split("\n").map(l => l.trim());
    for(let i = 1; i < lines.length; i++){
      if(!lines[i]) continue;
      const [date, weekday, weekend] = lines[i].split(",");
      if(date) blockedDates.add(date.trim());
      if(weekday && weekday.trim().toUpperCase() === "YES") blockedWeekday = true;
      if(weekend && weekend.trim().toUpperCase() === "YES") blockedWeekend = true;
    }
  } catch(err) {
    console.error("Ошибка загрузки Google Sheet", err);
  }
}


function updateDeliveryFields() {
  const method = methodSelect.value?.toLowerCase();

  if(method === "доставка" || method === "самовывоз"){
    deliveryFields.style.display = "block";

    if(method === "доставка"){
      deliveryNote.style.display = "block";        
      deliveryAddress.style.display = "block";     
    } else { 
      deliveryNote.style.display = "none";         
      deliveryAddress.style.display = "none";      
    }

    // Сбрасываем дату и время при смене метода
    selectedDate = null;
    chooseDateBtn.textContent = method === "доставка" ? "Выбрать дату *" : "Выбрать дату *";
    deliveryTime.innerHTML = "";
  } else {
    deliveryFields.style.display = "none";
    deliveryCalendar.style.display = "none";
    selectedDate = null;
    chooseDateBtn.textContent = "Выбрать дату";
    deliveryTime.innerHTML = "";
  }
}

// Навешиваем обработчик на select
methodSelect?.addEventListener('change', () => {
  updateDeliveryFields();
  renderCalendar();       // обновляем календарь
  updateDeliveryTimes();  // обновляем список времени
});

// вызовем один раз при старте, чтобы корректно отобразить поля при перезагрузке
updateDeliveryFields();


// ===== ОТКРЫТИЕ КАЛЕНДАРЯ =====
chooseDateBtn?.addEventListener('click', () => {
  deliveryCalendar.style.display = "block";
  renderCalendar();
});

// ===== РЕНДЕР КАЛЕНДАРЯ =====
function renderCalendar() {
  deliveryCalendar.innerHTML = '';
  const today = new Date();
  const maxDate = new Date();
  maxDate.setDate(today.getDate() + 6);

  const dates = [];
  const current = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  while(current <= maxDate){
    dates.push(new Date(current));
    current.setDate(current.getDate() + 1);
  }

  const months = {};
  dates.forEach(d => {
    const key = d.getFullYear() + '-' + (d.getMonth()+1);
    if(!months[key]) months[key] = [];
    months[key].push(d);
  });

  for(const [key, monthDates] of Object.entries(months)){
    const monthLabel = document.createElement('div');
    monthLabel.className = 'month-label';
    monthLabel.textContent = monthDates[0].toLocaleString('default', { month: 'long', year: 'numeric' });
    monthLabel.style.marginTop = "20px";
    deliveryCalendar.appendChild(monthLabel);

    const daysContainer = document.createElement('div');
    daysContainer.className = 'days';

    const firstDate = new Date(monthDates[0].getFullYear(), monthDates[0].getMonth(), 1);
    const lastDate = new Date(monthDates[0].getFullYear(), monthDates[0].getMonth() + 1, 0);

    const startDay = (firstDate.getDay() + 6) % 7;
    for(let i=0; i<startDay; i++){
      const emptyDiv = document.createElement('div');
      daysContainer.appendChild(emptyDiv);
    }

    for(let day=1; day<=lastDate.getDate(); day++){
      const date = new Date(firstDate.getFullYear(), firstDate.getMonth(), day);
      const dayDiv = document.createElement('div');
      dayDiv.className = 'day';
      dayDiv.textContent = day;

      const isoDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
      dayDiv.dataset.date = isoDate;

      // Блокировка по Google Sheets
      const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
      const isWeekday = (date.getDay() >= 1 && date.getDay() <= 5);

      if(dates.some(d => d.getDate()===date.getDate() && d.getMonth()===date.getMonth() && d.getFullYear()===date.getFullYear())){
        dayDiv.classList.add('available');
        if(blockedDates.has(`${date.getDate().toString().padStart(2,'0')}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getFullYear()}`) ||
           (blockedWeekend && isWeekend) ||
           (blockedWeekday && isWeekday)){
          dayDiv.classList.remove('available');
          dayDiv.classList.add('unavailable');
        }
      } else {
        dayDiv.classList.add('unavailable');
      }

      if(selectedDate === isoDate){
        dayDiv.classList.add('selected');
      }

      dayDiv.addEventListener('click', () => {
    if(dayDiv.classList.contains('unavailable')) return;

    const [year, month, day] = isoDate.split('-').map(Number);

    // selectedDate в формате дд.мм.гггг
    selectedDate = `${day.toString().padStart(2,'0')}.${month.toString().padStart(2,'0')}.${year}`;

    chooseDateBtn.textContent = "Дата: " + selectedDate;
    deliveryCalendar.style.display = "none";

    renderCalendar();
    updateDeliveryTimes(); // сразу обновляем список времени для выбранной даты
});


      daysContainer.appendChild(dayDiv);
    }

    deliveryCalendar.appendChild(daysContainer);
  }
}

// ===== ЗАГРУЗКА БЛОКИРОВОК И СТАРТОВЫЙ РЕНДЕР =====
loadBlockedDates().then(() => renderCalendar());










  let delivery = subtotal >= FREE_DELIVERY_LIMIT ? 0 : DELIVERY_COST;
  const method = checkoutForm?.method?.value?.toLowerCase();
    if (method === "самовывоз") delivery = 0;

    let discount = 0;

  if (activePromo) {
    switch (activePromo.type) {
      case 'cart_discount':
        discount = (subtotal + delivery) * (activePromo.value / 100);
        break;

      case 'flat_discount':
        discount = activePromo.value;
        break;

      case 'min_total_discount':
        if (subtotal >= activePromo.min) discount = activePromo.value;
        break;

      case 'free_delivery':
        delivery = 0;
        break;
    }
  }


// ===== СКИДКА (ПОКАЗЫВАЕМ ТОЛЬКО ЕСЛИ ЕСТЬ) =====
const discountRow = discountEl.parentElement;

if (
  (activePromo && activePromo.type === "free_item") ||
  discount > 0
) {
  discountRow.style.display = '';
  discountEl.textContent =
    activePromo?.type === "free_item"
      ? "Бесплатная позиция"
      : "-" + discount.toFixed(2) + " €";
} else {
  discountRow.style.display = 'none';
}

  const total = subtotal + delivery - discount;
  subtotalEl.textContent = subtotal.toFixed(2) + " €";
  deliveryEl.textContent = delivery.toFixed(2) + " €";
    totalEl.textContent = total.toFixed(2) + " €";

  // Значок количества в корзине
  if (cartCountEl) {
    let cnt = 0;
    cart.forEach(i => cnt += i.qty);
    cartCountEl.textContent = cnt;
  }
  saveCart();
  savePromo();
  updateDeliveryTimes();
}


// ===== ИНИЦИАЛЬНЫЙ РЕНДЕР =====
loadCart();
loadPromo();

// ===== АВТОРАСКРЫТИЕ ПРОМОБЛОКА ПРИ ПЕРЕЗАГРУЗКЕ =====
if (localStorage.getItem('activePromo')) {
    promoBox.style.display = 'block';
    showPromoBtn.style.display = 'none';
}


document.addEventListener('DOMContentLoaded', () => {
  const checkoutForm = document.getElementById('checkoutForm');
  const placeOrderBtn = document.getElementById('placeOrder');
  const paymentSelect = checkoutForm?.querySelector('[name="payment"]');

  if (!checkoutForm || !placeOrderBtn || !paymentSelect) return;

  function updateButton() {
    if (paymentSelect.value === 'Карта онлайн') {
      placeOrderBtn.textContent = 'Перейти к оплате';
    } else {
      placeOrderBtn.textContent = 'Оформить заказ';
    }
  }

  paymentSelect.addEventListener('change', updateButton);
  updateButton(); // при загрузке
});

const langBtns = document.querySelectorAll('.lang-switcher .lang-btn');
let currentLang = 'ru';

langBtns.forEach(btn => {
  btn.addEventListener('click', () => {
    currentLang = btn.dataset.lang;
    langBtns.forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateTexts(); // функция смены текста на выбранный язык
  });
});


updateCartUI();

</script>
</body>
</html>