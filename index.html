<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SUSHI メ</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0f0f10;
  --muted:#b9b9b9;
  --accent:#ff2d2d;
  --maxw:1600px;
}
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:"Montserrat","Noto Sans JP",system-ui,-apple-system,Roboto,"Segoe UI",Arial;
  background:
    linear-gradient(180deg,#0b0b0c 0%, #111214 100%);
  color:#eaeaea;
  -webkit-font-smoothing:antialiased;
  padding:36px 20px;
  display:flex;
  justify-content:center;
}
.wrap{width:100%; max-width:var(--maxw);}
header.brand{
  display:flex;
  justify-content:center;
  margin-bottom:50px; 
}
header.brand h1{
  font-size:3rem;
  gap:8px;
  justify-content:center;
}
header.brand h1 .jp{
  font-family:"Noto Sans JP"; 
  font-weight:700; 
  font-size:3.2rem; 
  color: #ff0000;
}
.note-orders-disabled {
  color: var(--accent);
  font-weight: 700;
  font-size: 1.3rem;
  text-align: center;
  margin-top: 25px; 
}
.card{
  background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.02));
  border-radius:12px;
  overflow:hidden;
  border: 1px solid rgba(255,45,45,0.2);
  transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, opacity 0.5s ease;
  display:flex;
  flex-direction:column;
  position: relative;
  opacity: 0;
  transform: translateY(20px);
}
.card.visible{
  opacity: 1;
  transform: translateY(0);
}
.card:hover{
  transform: translateY(-6px); 
  box-shadow: 0 18px 40px rgba(255,45,45,0.6);
  border-color: var(--accent);
}
.photo{
  width:100%; 
  height:250px; 
  background-size:cover; 
  background-position:center; 
  position: relative;
  border-radius:12px 12px 0 0; 
}
.overlay-unavailable{
  position:absolute;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.7);
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:700;
  font-size:1.2rem;
  pointer-events:none;
  opacity:0;
  transition: opacity 0.2s ease;
  border-radius:12px 12px 0 0;
}
.card.unavailable .overlay-unavailable{ opacity:1; }

.body{padding:16px; display:flex; flex-direction:column; gap:8px; flex:1; position:relative;}
.title{font-weight:700; margin:0; font-size:1.1rem; display:flex; justify-content:space-between; align-items:center;}
.title .name{
  display:flex;
  gap:6px;
  align-items:center;
  overflow:hidden;
  white-space:nowrap;
  text-overflow:ellipsis;
}
.label-jp {
  font-family: "Noto Sans JP";
  font-size: 0.9rem;
  color: var(--accent);
  background: rgba(255,43,43,0.12);
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: 700;
  max-width: 70px;
  overflow: hidden;
  white-space: nowrap;
  position: relative;
  display: inline-block;
}
.card.unavailable .label-jp { background: rgba(150,150,150,0.3); color: #aaa; }
.label-jp .scroll-text {
  display: inline-block;
  animation: scroll-marquee 5s cubic-bezier(0.3, 0.07, 0.66, 0.93) infinite alternate;
}
@keyframes scroll-marquee {
  0% { transform: translateX(0); }
  50% { transform: translateX(-50%); }
  100% { transform: translateX(0); }
}
.ingredients{margin:0; color:var(--muted); font-size:0.95rem; line-height:1.35;}
.bottom{display:flex; justify-content:space-between; align-items:center; margin-top:auto;}
.price{font-weight:800; color:var(--accent); font-size:1.05rem; display:flex; align-items:center; gap:8px; flex-wrap:wrap;}
.old-price{ color: var(--muted); text-decoration: line-through; font-weight:500; font-size:0.95rem; display:block; }
.discount{ color: #ff2d2d; font-weight:700; font-size:1rem; display:block; padding:0; background:none; }
.card.unavailable .price,
.card.unavailable .discount,
.card.unavailable .old-price { color: #aaa; }
.note{color:var(--muted); font-size:0.9rem;}
.cart-icon{
  position:absolute;
  top:6px;
  right:6px;
  width:39px;
  height:39px;
  background: rgba(0,0,0,0.6);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:5;
  transition: transform 0.2s ease, background 0.2s ease;
}
.cart-icon.hidden { display:none; }
.cart-icon img{width:26px;height:26px;object-fit:contain;}
.cart-icon:hover{transform: scale(1.2);}

/* Новый бейдж "Скидка" */
.discount-badge {
  position: absolute;
  top:6px;
  left:6px;
  height:36px;
  background: rgba(0,0,0,0.65);
  color: #ff2d2d;
  font-weight: 700;
  font-size: 0.85rem;
  border-radius: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 12px;
  pointer-events: none;
  opacity: 0.75;
  z-index: 5;
}
.card.has-discount .discount-badge {
  opacity: 1;
  animation: badgePulse 2.5s infinite ease-in-out;
}
@keyframes badgePulse {
  0%,100% { opacity:0.75; transform: scale(1); }
  50% { opacity:1; transform: scale(1.12); }
}

.toast {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.65);
  padding: 20px 36px;
  border-radius: 12px;
  font-weight:700;
  font-size:1.3rem;
  text-align:center;
  opacity:0;
  transition: opacity 0.5s ease;
  z-index:9999;
  pointer-events:none;
}
.toast.show { opacity:1; }
.toast.red { color: #ff2d2d; }
.toast.white { color: #fff; }

.floating-cart {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(255,43,43,0.45);
  color: #fff;
  padding: 14px 20px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.floating-cart img { width: 30px; height: 30px; }
.floating-cart:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.5);}

/* Адаптив для телефонов */
@media (max-width: 767px) {
  .card .body {
    padding-bottom: 6px; /* было 16px, уменьшаем, чтобы нижняя граница ближе */
  }

  .card .bottom {
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    margin-top:auto;
    padding-bottom: 5px; /* текст ближе к низу */
  }

  .card .price { font-size:1.18rem; margin:0; line-height:1; }
  .card .discount { font-size:1.18rem; margin:0; line-height:1; }
  .card .old-price { font-size:1.14rem; margin:0; line-height:1; }
  .card .note { font-size:1.02rem; margin:0; line-height:1; }

  /* Плашка "Скидка" больше */
  .discount-badge {
    font-size:1.1rem;
    padding:0 16px;
    height:42px;
  }
}

/* Адаптив для планшетов/ПК */
@media (min-width: 768px) {
  .discount-badge { top:4px; left:4px; } /* ближе к краю на 2-3 пикселя */
}


html, body {
  background-color: #0f0f10;
  overscroll-behavior: none; /* отключает пружинку на iOS/Android */
  height: 100%;
}

body {
  background-attachment: fixed; /* чтобы градиент не двигался */
  background-repeat: no-repeat;
  background-size: cover;
}

@media (max-width: 767px) {
  body {
    padding-bottom: 100px; /* добавляем пустоту снизу для мобильных */
  }
}




@import url('https://fonts.googleapis.com/css2?family=Jost:wght@500;600&display=swap');

:root {
  --accent: #ff2d2d;
  --text: #ffffff;
}

.menu-filters button,
.menu-filters-floating button {
  font-family: 'Jost', sans-serif;
  background: rgba(255, 45, 45, 0.12);
  border: none;
  color: var(--text);
  padding: 10px 20px;
  border-radius: 40px;
  font-weight: 600;
  font-size: 1rem;
  letter-spacing: 0.4px;
  cursor: pointer;
  transition: all 0.25s ease;
  white-space: nowrap;
}

.menu-filters button:hover,
.menu-filters-floating button:hover {
  background: var(--accent);
  color: #fff;
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(255,45,45,0.3);
}

.menu-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-bottom: 30px;
}

.menu-filters-floating {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  background: rgba(15,15,16,0.9);
  padding: 10px 0;
  transform: translateY(-100%);
  opacity: 0;
  transition: transform 0.25s ease, opacity 0.25s ease;
  z-index: 999;
  backdrop-filter: blur(8px);
}

.menu-filters-floating.show {
  transform: translateY(0);
  opacity: 1;
}

@media (max-width: 767px) {
  .menu-filters button,
  .menu-filters-floating button {
    font-size: 0.9rem;
    padding: 8px 14px;
  }
}

.menu-section {
  margin-bottom: 60px;
}

.section-title {
  font-family: 'Jost', sans-serif; /* или Raleway */
  font-weight: 700;
  font-size: 1.8rem;
  color: #fff;
  margin-bottom: 20px;
  text-align: center;
}

.menu-section .grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center; /* центрируем карточки */
  gap: 30px;
}

.menu-section .grid > .card {
  max-width: 615px; /* сохраняем */
  flex: 1 1 320px;  /* карточка растет до доступного места, но не меньше 320px */
}

.menu-bottom-space {
  height: 70px; /* регулируй под нужное пространство */
  width: 100%;
}

/* Исходное состояние всех элементов */
.card,
.menu-filters,
.menu-content {
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s ease;
}

/* Состояние "видимые" */
.card.visible,
.menu-filters.show,
.menu-content.show {
  opacity: 1;
  transform: translateY(0);
}

/* Названия секций */
.section-title {
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.6s ease;
}

.section-title.visible {
  opacity: 1;
  transform: translateY(0);
}

/* Активная кнопка фильтра */
.menu-filters button.active-filter,
.menu-filters-floating button.active-filter {
  background: var(--accent);
  color: #fff;
  transform: translateY(-1px);
  box-shadow: 0 4px 10px rgba(255,45,45,0.3);
}







.roll-select-wrapper {
  position: relative;
  top: 6px;
  width: 205px; /* можно под карточку */
  margin: 0 auto;
  font-family: 'Arial', sans-serif;
}


.select-btn {
  width: 100%;
  background: rgba(0,0,0,0.5); /* стильный полупрозрачный черный */
  color: #fff;
  border: none;
  border-radius: 25px; /* плавные закругления */
  padding: 12px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.3s, transform 0.2s;
  backdrop-filter: blur(5px);
}

.select-btn:hover {
  background: rgba(0,0,0,0.7);
  transform: scale(1.02);
}

.arrow {
  margin-left: 10px;
  transition: transform 0.3s;
}

.select-dropdown {
  position: absolute;
  top: 110%;
  left: 0;
  right: 0;
  background: rgba(0,0,0,0.5);
  border-radius: 20px;
  padding: 5px 0;
  list-style: none;
  overflow: hidden;
  max-height: 0;
  opacity: 0;
  transition: max-height 0.4s ease, opacity 0.4s ease;
  box-shadow: 0 8px 20px rgba(0,0,0,0.3);
  backdrop-filter: blur(5px);
  z-index: 10;
}

.select-dropdown.show {
  max-height: 300px; /* достаточно для всех элементов */
  opacity: 1;
}

.select-dropdown li {
  padding: 10px 20px;
  text-align: center;
  cursor: pointer;
  color: #fff;
  transition: background 0.2s, color 0.2s;
}

.select-dropdown li:hover {
  background: rgba(255, 45, 45, 0.2);
  color: #ff2d2d;
}





/* Плавающая корзина */
.floating-cart {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(255,43,43,0.45);
  color: #fff;
  padding: 14px 20px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 700;
  font-size: 1rem;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.floating-cart:hover { 
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.18); /* эффект поднятия */
}
.cart-count {
  background: #FF7A59;        /* основной акцентный цвет кнопок/скидок */
  color: #fff;
  font-weight: bold;
  border-radius: 50%;
  width: 20px;
  height: 20px;
  text-align: center;
  font-size: 12px;
}

/* Fullscreen корзина */
.cart-fullscreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #0f0f10;           /* фон как у секций меню */
  transform: translateX(100%);
  transition: transform 0.3s ease;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  color: #ffffff;                   /* текст как на карточках */
}
.cart-fullscreen.open { transform: translateX(0); }

.cart-fullscreen .cart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  font-size: 20px;
  font-weight: bold;
  border-bottom: 1px solid #eee;
}
.cart-fullscreen .cart-header button {
  background: none;
  border: none;
  font-size: 35px;
  color: #ff0000;              /* кнопка закрытия в акцентном цвете */
  cursor: pointer;
}

/* Товары в корзине */
.cart-items {
  padding: 16px 24px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.cart-item {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 12px;
  background: #100f0f;             /* фон карточки */
  box-shadow: 0 2px 8px rgba(255, 255, 255, 0.2);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.cart-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(255,45,45,0.6);
}
.cart-item span {
  font-size: 14px;
  font-family:"Montserrat","Noto Sans JP",system-ui,-apple-system,Roboto,"Segoe UI",Arial;
  color: #bcbcbc85;                  /* текст как в карточках */
}
.cart-item-qty {
  text-align: center;
}
.cart-item-total {
  font-weight: bold;
  text-align: right;
  color: #FF7A59;               /* итоговая цена выделена акцентным цветом */
}

/* Итог */
.cart-total {
  display: flex;
  justify-content: space-between;
  font-size: 18px;
  font-weight: bold;
  padding: 16px 24px;
  border-top: 1px solid #eee;
  color: #ffffff;
}

/* Фон при открытии */
.cart-backdrop {
  position: fixed;
  top:0; left:0;
  width:100%; height:100%;
  background: rgba(0,0,0,0.25);  /* мягкий затемненный фон */
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease;
  z-index: 900;
}
.cart-backdrop.show {
  opacity: 1;
  visibility: visible;
}







/* ---------- Cart fullscreen styles (custom) ---------- */
.cart-fullscreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1100;
  pointer-events: none;
}
.cart-fullscreen[aria-hidden="true"] { opacity: 0; transform: translateX(100%); transition: transform .28s ease, opacity .2s ease; }
.cart-fullscreen[aria-hidden="false"] { opacity: 1; transform: translateX(0); pointer-events: auto; transition: transform .28s ease, opacity .2s ease; }

.cart-inner {
  width: calc(100% - 36px);
  max-width: 2980px;
  height: calc(100% - 64px);
  background: linear-gradient(180deg, #0e0e0f 0%, #121213 100%);
  border-radius: 16px;
  overflow: auto;
  box-shadow: 0 30px 80px rgba(0,0,0,0.6);
  border: 1px solid rgba(255,45,45,0.06);
  display: flex; flex-direction: column;
  padding: 20px;
}

/* Header */
.cart-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:16px;
  padding-bottom:8px;
  border-bottom: 1px solid rgba(255,255,255,0.03);
}
.cart-title { font-size:1.35rem; font-weight:700; color:#fff; margin:0; }
.cart-close {
  background:transparent;
  border: none;
  font-size:28px;
  color:#ff4c4c;
  cursor:pointer;
  line-height:1;
}

/* Body layout */
.cart-body {
  display:flex;
  gap:20px;
  padding-top:18px;
  padding-bottom:30px;
  align-items:flex-start;
  flex:1;
  flex-direction:column;
}

/* Items list */
.cart-items {
  display:flex;
  flex-direction:column;
  gap:14px;
  width:100%;
}

/* Single item */
.cart-item {
  display:flex;
  align-items:center;
  gap:12px;
  background:#111111;
  border-radius:18px;
  padding:14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
  border:1px solid rgba(255,255,255,0.02);
}
.cart-item .name { flex:1; font-weight:600; color:#fff; font-size:1.02rem; }
.cart-item .unit { width:84px; color: #d7d7d7f1; text-align:center; }
.cart-item .line-total { width:84px; text-align:right; font-weight:600; color:#ff2d2d; }
.cart-item .qty-wrap {
  display:flex;
  align-items:center;
  gap:8px;
  background:#0e0e0e;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,0.03);
}
.qty-btn {
  background:transparent;
  border:none;
  font-size:18px;
  color:#bfbfbf;
  cursor:pointer;
  padding:6px;
}
.qty-value { min-width:28px; text-align:center; font-weight:600; color:#fff; }

/* Remove button */
.remove-btn {
  background:transparent;
  border:none;
  color:#ff0000;
  font-size:20px;
  cursor:pointer;
  margin-left:8px;
}

/* Summary */
.cart-summary {
  margin-top:16px;
  border-radius:12px;
  padding:14px;
  background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.02));
  border: 1px solid rgba(255,255,255,0.02);
  color:#d0d0d0;
  width:100%;
  max-width:420px;
}
.summary-row { display:flex; justify-content:space-between; padding:6px 0; color:#bfbfbf; }
.summary-divider { height:1px; background:rgba(255,255,255,0.03); margin:10px 0; }
.summary-total { display:flex; justify-content:space-between; padding-top:6px; font-weight:800; font-size:1.15rem; color:#fff; }

/* Checkout card */
.checkout-card {
  margin-top:18px;
  background:#111111;
  padding:16px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.02);
  width:100%;
  max-width:420px;
}
.checkout-card h3 { margin:0 0 10px 0; color:#fff; font-weight:700; }
.checkout-form { display:flex; flex-direction:column; gap:10px; }
.checkout-form input,
.checkout-form select {
  padding:12px 14px;
  border-radius:12px;
  background:#0b0b0b;
  border:1px solid rgba(255,255,255,0.03);
  color:#fff;
  outline:none;
}
.checkout-actions { display:flex; gap:10px; margin-top:8px; }
.btn-primary {
  background: linear-gradient(90deg,#ff4c4c,#ff7a59);
  color:#fff;
  border:none;
  padding:12px 16px;
  border-radius:12px;
  cursor:pointer;
  font-weight:700;
}
.btn-ghost {
  padding:12px 14px;
  border-radius:12px;
  background:#0b0b0b;
  border:1px solid rgba(255,255,255,0.03);
  color:#fff;
  outline:none;
}

/* Responsive */
@media (min-width:1500px) {
  .cart-body { flex-direction:row; align-items:flex-start;}
  .cart-items { flex:1 1 56%; }
  .cart-summary, .checkout-card { flex: 0 0 44%; }
}

@media (max-width:1500px) {
  .cart-body { flex-direction:row; align-items:flex-start; flex-direction: column; align-items: center; }

}

@media (max-width:899px) {
  .cart-inner { padding:16px; border-radius:12px; }
  .cart-body { gap:12px; }
}

.free-delivery-info {
    text-align: center;
    color: #ff2d2d;
    font-weight: 600;
    margin-bottom: -20px;
    display: none; /* скрыто до загрузки таблицы */
    font-size: 16.5px;
}


/* На телефоне адаптация */
@media (max-width: 899px) {
  .free-delivery-info {
    text-align: center;
    font-size: 13px;
    line-height: 1.2em;
    overflow: hidden;
    text-overflow: ellipsis;
    word-wrap: break-word;
    white-space: normal;
    margin-top: 4px;
    margin-bottom: 12px;
  }
}



@media (max-width: 599px) {
.cart-item {
  position: relative; /* чтобы позиционировать крестик */
  display: flex;
  flex-direction: column;
  gap:6px;
  background:#111111;
  border-radius:18px;
  padding:12px;
  border:1px solid rgba(255,255,255,0.02);
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
}



  .cart-item .line-total {
    text-align: center; /* итоговую цену оставляем справа */
  }
}

/* ===== Крестик удаления товара ===== */
@media (max-width: 599px) {
.remove-btn {
  position: absolute; /* фиксируем в углу */
  top: 8px;
  right: 8px;
  background:transparent;
  border:none;
  color:#ff0000;
  font-size:20px;
  cursor:pointer;
  z-index:10;
}}







/* Кнопка открытия поля */
.promo-toggle-btn {
  width: 100%;
  margin-top: 10px;
}

/* Коробка промокода использует стиль как у checkout-form */
.promo-code-box {
  width: 100%;
  margin-top: 12px;
}

.promo-code-box input {
  margin-bottom: 10px;
}

.promo-actions {
  display: flex;
  gap: 8px;
}

.promo-message {
  margin-top: 8px;
  font-size: 14px;
  min-height: 18px;
}

.promo-message.success {
  color: #2ecc71;
}

.promo-message.error {
  color: #ff5252;
}

.promo-toggle-btn {
  width: 100%;
  margin-top: 12px;
}

/* Для экранов до 767px (телефоны) */
@media (max-width: 767px) {
  #checkoutForm input,
  #checkoutForm select,
  #checkoutForm textarea {
    font-size: 18px;       /* удобный размер для ввода */
  }

  #checkoutForm label {
    font-size: 16px;       /* текст метки чуть больше */
  }

  #checkoutForm button {
    font-size: 18px;       /* кнопки тоже крупнее */
  }
}






@media (max-width: 767px) {
  /* Поля формы */
  #checkoutForm input,
  #checkoutForm select,
  #checkoutForm textarea,
  #promoInput {

    box-sizing: border-box;
  }

  /* Метки полей */
  #checkoutForm label {
    font-size: 16px;
    margin-bottom: 6px;
    display: block;
  }

  /* Кнопки формы */
  #checkoutForm button,
  #applyPromo,
  #cancelPromo,
  .floating-cart,
  #showPromoBtn {    /* кнопка "ввести промокод" */
    font-size: 18px;

    box-sizing: border-box;
  }

  /* Блок промокода */
  .promo-code-box {
    padding: 10px;
  }

  #promoMessage {
    font-size: 16px;
  }

  /* Товары в корзине */
  .cart-item .name,
  .cart-item .unit,
  .cart-item .line-total {
    font-size: 16px;
  }

  .cart-item .qty-wrap button {
    font-size: 18px;
    padding: 6px 12px;
  }

  /* Отступы между полями */
  #checkoutForm .form-group {
    margin-bottom: 12px;
  }

  .promo-code-box input {
    margin-bottom: 10px;
    font-size: 18px;
}
}







.custom-calendar {
  display: flex;
  flex-direction: column;
  gap: 10px;
  background-color: #161616;
  padding: 10px;
  border-radius: 12px;
  color: #fff;
  width: 300px;
  font-family: sans-serif;
}

.custom-calendar .month-label {
  text-align: center;
  font-weight: bold;
  font-size: 1.2em;
  margin-bottom: 8px; /* небольшой отступ вниз, чтобы метка не прилипала к сетке дат */
}

.custom-calendar .days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
}

.custom-calendar .day {
  width: 35px;
  height: 35px;
  line-height: 35px;
  text-align: center;
  border-radius: 50%;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s, color 0.2s;
}

.custom-calendar .day.available {
  background-color: #000;
  color: #fff;
}

.custom-calendar .day.available:hover {
  background-color: #222;
}

.custom-calendar .day.unavailable {
  color: #686868;
  cursor: not-allowed;
  background-color: #333;
}

.custom-calendar .day.selected {
  background-color: #ff2d2d;
  color: #fff;
  font-weight: bold;
}


#deliveryCalendar {
  display: flex;
  flex-direction: column;
  align-items: center; /* Центрируем содержимое по горизонтали */
  margin: 10px auto;  /* Отступ сверху/снизу и авто слева/справа для центрирования */
  max-width: 320px;   /* Можно ограничить ширину */
  background-color: #181818;
  padding: 10px;
  border-radius: 12px;
}

.deliveryNote {
  color: #ff0000; /* красный цвет */
  text-align: center; /* по центру */
  font-weight: bold;
  margin-top: 8px;
}


/* ===== ОБЯЗАТЕЛЬНЫЕ ПОЛЯ ===== */
.required-star {
  color: #e53935;
  font-weight: 600;
  margin-left: 4px;
}

.required-field {
  border: 2px solid #e53935 !important;
  background: #fff6f6 !important;
}




</style>


<!-- Open Graph для соцсетей -->
<meta property="og:title" content="SUSHI メ" />
<meta property="og:image" content="https://sushix0.github.io/SUSHI-X/Foto/Logo.png" />
<meta property="og:type" content="website" />


</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DM67PTW8TB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DM67PTW8TB');
</script>

<body>


<div class="wrap">
  <header class="brand">
    <h1><span>SUSHI</span> <span class="jp">メ</span></h1>
  </header>
  <div class="note-orders-disabled" id="orders-disabled-note" style="display:none;">NB! Заказы временно не принимаются</div>

<!-- Основной фиксированный бар -->
<div class="menu-filters" id="menuFilters">
  <button>Предложения</button>
  <button>Урамаки</button>
  <button>Футомаки</button>
  <button>Маки</button>
  <button>Темпура</button>
  <button>Запечённые</button>
  <button>Нигири</button>
  <button>Наборы</button>
  <button>Дополнительно</button>
</div>

<!-- Плавающий бар -->
<div class="menu-filters-floating" id="menuFiltersFloating">
  <button>Предложения</button>
  <button>Урамаки</button>
  <button>Футомаки</button>
  <button>Маки</button>
  <button>Темпура</button>
  <button>Запечённые</button>
  <button>Нигири</button>
  <button>Наборы</button>
  <button>Дополнительно</button>
</div>


  <main>

<section class="menu-section" id="specialOffers">
  <h2 class="section-title">Предложения</h2>
  <div class="grid"></div>
</section>

  <!-- Раздел: Урамаки -->
  <section class="menu-section">
    <h2 class="section-title">Урамаки</h2>
    <div class="grid">
      <article class="card" data-id="филадельфия">
        <div class="photo" style="background-image:url('Foto/Shushi-1.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Филадельфия</span><span class="label-jp"><span class="scroll-text">フィラデルフィア</span></span></h3>
          <p class="ingredients">Лосось · Philadelphia · Огурец · Авокадо</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="снежный_краб">
        <div class="photo" style="background-image:url('Foto/Shushi-10.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Снежный краб</span><span class="label-jp"><span class="scroll-text">スノークラブ</span></span></h3>
          <p class="ingredients">Снежный краб · Philadelphia · Огурец</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="калифорния">
        <div class="photo" style="background-image:url('Foto/Shushi-11.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Калифорния</span><span class="label-jp"><span class="scroll-text">カリフォルニア</span></span></h3>
          <p class="ingredients">Снежный краб · Philadelphia · Огурец · Масаго</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="аляска">
        <div class="photo" style="background-image:url('Foto/Shushi-8.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Аляска</span><span class="label-jp"><span class="scroll-text">アラスカ</span></span></h3>
          <p class="ingredients">Угорь · Лосось · Philadelphia · Авокадо</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Футомаки -->
  <section class="menu-section">
    <h2 class="section-title">Футомаки</h2>
    <div class="grid">
      <article class="card" data-id="футомаки_с_крабом">
        <div class="photo" style="background-image:url('Foto/Shushi-4.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Футомаки с Крабом</span><span class="label-jp"><span class="scroll-text">クラブ太巻き</span></span></h3>
          <p class="ingredients">Огурец · Авокадо · Сыр Philadelphia · Крабовое мясо</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="футомаки_с_креветкой">
        <div class="photo" style="background-image:url('Foto/Shushi-3.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Футомаки с креветкой</span><span class="label-jp"><span class="scroll-text">エビ太巻き</span></span></h3>
          <p class="ingredients">Огурец · Сыр Philadelphia · Креветка</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Маки -->
  <section class="menu-section">
    <h2 class="section-title">Маки</h2>
    <div class="grid">
      <article class="card" data-id="маки_с_огурцом">
        <div class="photo" style="background-image:url('Foto/Shushi-7.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Маки с огурцом</span><span class="label-jp"><span class="scroll-text">キュウリ</span></span></h3>
          <p class="ingredients">Огурец</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="маки_с_омлетом">
        <div class="photo" style="background-image:url('Foto/Shushi-6.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Маки с омлетом</span><span class="label-jp"><span class="scroll-text">玉子巻</span></span></h3>
          <p class="ingredients">Японский омлет</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Темпура -->
  <section class="menu-section">
    <h2 class="section-title">Темпура</h2>
    <div class="grid">
      <article class="card" data-id="темпура_с_крабом">
        <div class="photo" style="background-image:url('Foto/Shushi-22.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Темпура с крабом</span><span class="label-jp"><span class="scroll-text">カニ天ぷら</span></span></h3>
          <p class="ingredients">Огурец · Сыр Philadelphia · Крабовое мясо</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="темпура_с_курицей">
        <div class="photo" style="background-image:url('Foto/Shushi-13.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Темпура с курицей</span><span class="label-jp"><span class="scroll-text">チキン天ぷら</span></span></h3>
          <p class="ingredients">Огурец · Паприка · Сыр Philadelphia · Курица</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Запечённые -->
  <section class="menu-section">
    <h2 class="section-title">Запечённые</h2>
    <div class="grid">
      <article class="card" data-id="запечённый_ролл_нико">
        <div class="photo" style="background-image:url('Foto/Shushi-19.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
          </div>
        <div class="body">
          <h3 class="title"><span class="name">Запечённый Ролл «Нико»</span><span class="label-jp"><span class="scroll-text">ニコ焼きロール</span></span></h3>
          <p class="ingredients">Огурец · Сыр Philadelphia · Лосось, Крабовое мясо · Масаго</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="запечённый_ролл_салмон">
        <div class="photo" style="background-image:url('Foto/Shushi-18.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Запечённый Ролл «Сaлмон»</span><span class="label-jp"><span class="scroll-text">サーモン焼きロール</span></span></h3>
          <p class="ingredients">Авокадо · Сыр Philadelphia · Лосось</p>
          <div class="bottom"><div class="note">8 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Нигири -->
  <section class="menu-section">
    <h2 class="section-title">Нигири</h2>
    <div class="grid">
      <article class="card" data-id="нигири_с_креветкой">
        <div class="photo" style="background-image:url('Foto/Shushi-27.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Нигири с креветкой</span><span class="label-jp"><span class="scroll-text">海老握り</span></span></h3>
          <p class="ingredients">Креветка</p>
          <div class="bottom"><div class="note">2 шт</div><div class="price"></div></div>
        </div>
      </article>

      <article class="card" data-id="нигири_с_угрём">
        <div class="photo" style="background-image:url('Foto/Shushi-28.jpg');">
          <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
          <div class="overlay-unavailable"></div>
        </div>
        <div class="body">
          <h3 class="title"><span class="name">Нигири с угрём</span><span class="label-jp"><span class="scroll-text">鰻握り</span></span></h3>
          <p class="ingredients">Угорь</p>
          <div class="bottom"><div class="note">2 шт</div><div class="price"></div></div>
        </div>
      </article>
    </div>
  </section>

  <!-- Раздел: Наборы -->
<section class="menu-section">
  <h2 class="section-title">Наборы</h2>
  <div class="grid">
    <article class="card" data-id="классика">
      <div class="photo" style="background-image:url('Foto/');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Классика</span><span class="label-jp"><span class="scroll-text">クラシック</span></span></h3>
        <p class="ingredients">Филадельфия · Снежный краб · Маки с огурцом</p>
        <div class="bottom"><div class="note">24 шт</div><div class="price"></div></div>
      </div>
    </article>

    <article class="card" data-id="премиум">
      <div class="photo" style="background-image:url('Foto/');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Премиум</span><span class="label-jp"><span class="scroll-text">プレミアム</span></span></h3>
        <p class="ingredients">Филадельфия · Аляска · Нигири с угрём · Нигири с креветкой</p>
        <div class="bottom"><div class="note">20 шт</div><div class="price"></div></div>
      </div>
    </article>
  </div>
</section>

<!-- Раздел: Дополнительно -->
<section class="menu-section">
  <h2 class="section-title">Дополнительно</h2>
  <div class="grid">
    <article class="card" data-id="соевый_соус">
      <div class="photo" style="background-image:url('Foto/');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Соевый соус</span><span class="label-jp"><span class="scroll-text">醤油</span></span></h3>
        <p class="ingredients"></p>
        <div class="bottom"><div class="note">50 мл</div><div class="price"></div></div>
      </div>
    </article>

    <article class="card" data-id="имбирь">
      <div class="photo" style="background-image:url('Foto/Shushi-31.jpg');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Имбирь</span><span class="label-jp"><span class="scroll-text">生姜</span></span></h3>
        <p class="ingredients"></p>
        <div class="bottom"><div class="note">50 г</div><div class="price"></div></div>
      </div>
    </article>

    <article class="card" data-id="вакаме">
      <div class="photo" style="background-image:url('Foto/Shushi-30.jpg');">
        <div class="cart-icon"><img src="Foto/cart.png" alt="Корзина"></div>
        <div class="overlay-unavailable"></div>
      </div>
      <div class="body">
        <h3 class="title"><span class="name">Вакаме</span><span class="label-jp"><span class="scroll-text">ワカメ</span></span></h3>
        <p class="ingredients"></p>
        <div class="bottom"><div class="note">50 г</div><div class="price"></div></div>
      </div>
    </article>
  </div>
</section>



  <div class="menu-bottom-space"></div>
</main>
</div>

<div class="toast" id="toast">Товар добавлен в корзину</div>
<div class="floating-cart">
  <img src="Foto/cart.png" alt="Корзина">
  <span>Корзина</span>
</div>




<!-- Fullscreen корзина -->
<div id="cartFullscreen" class="cart-fullscreen" aria-hidden="true">
  <div class="cart-inner">
    <div class="cart-header">
      <h2 class="cart-title">Корзина</h2>
      <div id="free-delivery-info" class="free-delivery-info"></div>

      <button id="closeCart" class="cart-close" aria-label="Закрыть корзину">&times;</button>
    </div>

    <div class="cart-body">
      <!-- Список товаров -->
      <div class="cart-items" role="list"></div>

      <!-- Итоги -->
      <div class="cart-summary">
        <div class="summary-row"><span>Товары</span><span class="subtotal-price">0.00 €</span></div>
        <div class="summary-row"><span>Доставка</span><span class="delivery-price">0.00 €</span></div>
        <div class="summary-row"><span>Скидка</span><span class="discount-price">0.00 €</span></div>
<!-- Кнопка показать поле промокода -->
<button id="showPromoBtn" class="btn-primary promo-toggle-btn">Ввести промокод</button>


<!-- Поле для ввода промокода (изначально скрыто) -->
<div class="promo-code-box" style="display:none;">
  <div class="checkout-form input"><input id="promoInput" type="text" placeholder="Промокод"></div>
 
  
  <div class="promo-actions">
    <button id="applyPromo" class="btn-primary">Применить</button>
    <button id="cancelPromo" class="btn-ghost">Отмена</button>
  </div>

  <div id="promoMessage" class="promo-message"></div>
</div>
        <div class="summary-divider"></div>
        <div class="summary-total"><span>Итого</span><span class="total-price">0.00 €</span></div>
      </div>

      <!-- Форма оформления -->
      <div class="checkout-card">
        <h3>Оформление заказа</h3>
        <form id="checkoutForm" class="checkout-form" onsubmit="return false;">
          <input name="name" type="text" placeholder="Имя *" autocomplete="name" />
          <input name="phone" type="tel" pattern="[+\d]*" placeholder="Номер телефона *" autocomplete="tel" required/>
          <input name="email" type="email" placeholder="Почта *" autocomplete="email" />
          <select name="payment">
            <option value="" disabled selected>Способ оплаты *</option>
            <option>Наличные</option>
            <option>Карта онлайн</option>
          </select>
          <select name="method">
            <option value="" disabled selected>Способ получения *</option>
            <option>Самовывоз</option>
            <option>Доставка</option>
          </select>

<div id="deliveryFields" style="display:none; margin-top:10px;">
  <p class="deliveryNote">NB! Доставка осуществляется только по Tiskre Küla</p>  
  <button type="button" class="btn-ghost" id="chooseDateBtn">Выбрать дату *</button>
  <div id="deliveryCalendar" class="custom-calendar" style="display:none;"></div>

<select id="deliveryTime"></select>

<input type="text" id="deliveryAddress" placeholder="Адрес доставки *" class="checkout-form">


</div>






          <div class="checkout-actions">
            <button id="placeOrder" class="btn-primary" type="button">Оформить заказ</button>
            <button id="clearCartBtn" class="btn-ghost" type="button">Очистить корзину</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="cartBackdrop" class="cart-backdrop"></div>





<script>
const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=0&single=true&output=csv';

// ===== Toast =====
function showToast(message, isRed = false) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show ' + (isRed ? 'red' : 'white');
  setTimeout(() => { toast.classList.remove('show'); }, 2500);
}

// ===== Плавающий фильтр =====
const mainBar = document.getElementById('menuFilters');
const floatingBar = document.getElementById('menuFiltersFloating');

function shouldShowFloatingBar() {
  if (window.innerWidth > 767) return true;
  const firstSection = document.querySelector('.menu-section .grid');
  if (!firstSection) return false;
  const cards = Array.from(firstSection.children);
  if (cards.length < 2) return false;
  const rect1 = cards[0].getBoundingClientRect();
  const rect2 = cards[1].getBoundingClientRect();
  return rect1.top === rect2.top;
}

window.addEventListener('scroll', () => {
  const mainTop = mainBar.getBoundingClientRect().top;
  if (!shouldShowFloatingBar() || mainTop > 0) floatingBar.classList.remove('show');
  else floatingBar.classList.add('show');

  updateActiveFilter();
});

window.addEventListener('resize', () => {
  if (!shouldShowFloatingBar()) floatingBar.classList.remove('show');
});

// ===== Обновление меню из Google Sheets =====
async function updateMenuFromSheet() {
  try {
    const res = await fetch(sheetUrl);
    const text = await res.text();
    const rows = text.trim().split('\n').map(r => r.split(','));
    const headers = rows[0].map(h => h.trim());
    const data = rows.slice(1).map(r => Object.fromEntries(r.map((v, i) => [headers[i], v.trim()])));

    let ordersEnabled = true;

    for (let item of data) {
      if(item['id'] && item['id'].toLowerCase() === 'orders_enabled') {
        ordersEnabled = (item['Доступно'] || item['Цена'] || item['Цена_со_скидкой'] || item['Скидка'] || item['Скрыто'] || 'yes').toLowerCase() === 'yes';
        document.getElementById('orders-disabled-note').style.display = ordersEnabled ? 'none' : 'block';
        continue;
      }


// НАСТРОЙКИ ДОСТАВКИ ИЗ ТАБЛИЦЫ
if (item['id'] && item['id'].toLowerCase() === 'delivery_cost') {
    DELIVERY_COST = parseFloat(item['Цена']?.replace(',', '.')) || 0;
    continue;
}

if (item['id'] && item['id'].toLowerCase() === 'free_delivery_limit') {
    FREE_DELIVERY_LIMIT = parseFloat(item['Цена']?.replace(',', '.')) || 0;
    continue;
}



      const el = document.querySelector(`.card[data-id="${item['id']}"]`);
      if (!el) continue;

      const priceEl = el.querySelector('.price');
      const overlay = el.querySelector('.overlay-unavailable');
      const cartIcon = el.querySelector('.cart-icon');

      const available = (item['Доступно'] || '').toLowerCase() === 'true';
      const hidden = (item['Скрыто'] || '').toLowerCase() === 'true';
      el.style.display = hidden ? 'none' : '';

      // Цена и скидка
      const basePrice = parseFloat(item['Цена'].replace(',', '.')) || 0;
      const discountPrice = parseFloat(item['Цена_со_скидкой']?.replace(',', '.')) || 0;
      const discountPercent = item['Скидка'] ? parseInt(item['Скидка']) : 0;
      let priceHTML = '';

      if (discountPrice > 0 && discountPrice < basePrice) {
        const formattedOld = basePrice.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const formattedNew = discountPrice.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        priceHTML = `<span class="discount">-${discountPercent}%</span> <span class="old-price">${formattedOld} €</span> <span class="new-price">${formattedNew} €</span>`;
        el.classList.add('has-discount');
        if (!el.querySelector('.discount-badge')) {
          const badge = document.createElement('div');
          badge.className = 'discount-badge';
          badge.textContent = 'Скидка';
          el.querySelector('.photo').appendChild(badge);
        }
      } else {
        const formattedBase = basePrice.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        priceHTML = `${formattedBase} €`;
        el.classList.remove('has-discount');
      }
      if(priceEl) priceEl.innerHTML = priceHTML;

      // Доступность
      if (!available) {
        el.classList.add('unavailable');
        if(overlay) overlay.textContent = 'Временно недоступно';
        if(cartIcon) cartIcon.classList.add('hidden');
      } else {
        el.classList.remove('unavailable');
        if(overlay) overlay.textContent = '';
        if(cartIcon) ordersEnabled ? cartIcon.classList.remove('hidden') : cartIcon.classList.add('hidden');
      }
    }

    // Корзина
document.querySelectorAll('.cart-icon').forEach(icon => {
  icon.addEventListener('click', () => {
    const card = icon.closest('.card');
    addToCart(card);
  });
});

    document.querySelector('.floating-cart').onclick = () => {
  if(!ordersEnabled) showToast('Заказы временно не принимаются', true);
  // иначе ничего не делаем, чтобы надпись не появлялась
};


    // Специальные предложения
    updateSpecialOffersSection();

renderCart();


  } catch (e) { console.error('Ошибка загрузки меню', e); }
}

// ===== Специальные предложения =====
function updateSpecialOffersSection() {
  const specialGrid = document.querySelector('#specialOffers .grid');
  const specialSection = document.getElementById('specialOffers');
  const buttons = document.querySelectorAll('#menuFilters button, #menuFiltersFloating button');

  if (!specialGrid || !specialSection) return;
  specialGrid.innerHTML = '';
  const discountedCards = document.querySelectorAll('.card.has-discount');

  if (discountedCards.length > 0) {
    discountedCards.forEach(card => {
      const clone = card.cloneNode(true);
      specialGrid.appendChild(clone);
    });

    specialSection.style.display = 'block';
    specialSection.classList.add('special-offers-section');

    buttons.forEach(btn => { 
      if(btn.textContent.trim().toLowerCase() === 'предложения') btn.style.display='inline-block'; 
    });

    // Навешиваем корзину на клонированные карточки
specialGrid.querySelectorAll('.cart-icon').forEach(icon => {
  icon.onclick = () => {
    const card = icon.closest('.card');
    addToCart(card); // теперь товары добавляются в корзину с учётом количества
  }
});


  } else {
    specialSection.style.display = 'none';
    buttons.forEach(btn => { 
      if(btn.textContent.trim().toLowerCase() === 'предложения') btn.style.display='none'; 
    });
  }
}

// ===== Анимация карточек =====
function animateCards() {
  const sections = document.querySelectorAll('.menu-section');
  sections.forEach((section, secIndex) => {
    const cards = section.querySelectorAll('.card');
    cards.forEach((card, i) => {
      card.style.opacity = 0;
      card.style.transform = 'translateY(20px) scale(0.95)';
      setTimeout(() => {
        card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        card.style.opacity = 1;
        card.style.transform = 'translateY(0) scale(1)';
      }, i * 60 + secIndex * 120);
    });
    const title = section.querySelector('.section-title');
    if (title) {
      title.style.opacity = 0;
      title.style.transform = 'translateY(20px)';
      setTimeout(() => {
        title.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        title.style.opacity = 1;
        title.style.transform = 'translateY(0)';
      }, cards.length * 60 + secIndex * 130);
    }
    setTimeout(() => section.classList.add('show'), cards.length * 60 + secIndex * 150);
  });
  mainBar.classList.add('show');
}

// ===== Активный фильтр =====
const sections = document.querySelectorAll('.menu-section');
const buttons = document.querySelectorAll('#menuFilters button, #menuFiltersFloating button');

function updateActiveFilter() {
  const scrollTop = window.scrollY + 120; // небольшой отступ сверху
  let currentSection = null;

    // Если пользователь в самом верху страницы — активируем первый раздел
  if (window.scrollY < 50) {
    const firstSection = sections[0];
    if (firstSection) {
      const firstName = firstSection.querySelector('.section-title')?.textContent.trim().toLowerCase();
      buttons.forEach(btn => {
        if (btn.textContent.trim().toLowerCase() === firstName) btn.classList.add('active-filter');
        else btn.classList.remove('active-filter');
      });
    }
    return; // чтобы не выполнялась остальная часть
  }


  const specialSection = document.querySelector('.special-offers-section');
  if (specialSection) {
    const sectionTop = specialSection.offsetTop;
    const sectionBottom = sectionTop + specialSection.offsetHeight;
    if (scrollTop >= sectionTop && scrollTop < sectionTop + specialSection.offsetHeight / 2) {
      currentSection = specialSection;
    }
  }

  if (!currentSection) {
    sections.forEach(sec => {
      if (sec.classList.contains('special-offers-section')) return;
      const top = sec.offsetTop;
      const bottom = top + sec.offsetHeight;
      if (scrollTop >= top && scrollTop < bottom) {
        currentSection = sec;
      }
    });
  }

  if (!currentSection) return;
  const sectionName = currentSection.querySelector('.section-title')?.textContent.trim().toLowerCase();
  buttons.forEach(btn => {
    if (btn.textContent.trim().toLowerCase() === sectionName) btn.classList.add('active-filter');
    else btn.classList.remove('active-filter');
  });
}

// ===== Плавный скролл по кнопке =====
buttons.forEach(btn => {
  btn.addEventListener('click', e => {
    const text = e.target.textContent.trim().toLowerCase();
    const targetSection = Array.from(sections).find(sec => {
      const title = sec.querySelector('.section-title');
      return title && title.textContent.trim().toLowerCase() === text;
    });
    if (targetSection) {
      window.scrollTo({
        top: targetSection.offsetTop - 80,
        behavior: 'smooth'
      });
    }
  });
});

// ===== Инициализация =====
(async () => {
  await updateMenuFromSheet();   // ждем загрузку меню
  updateActiveFilter();          // обновляем активный фильтр
  setTimeout(() => {
    animateCards();              // запускаем анимацию
  }, 250);
  
})();


// ===== Выбор шапочки =====
const rollSelectWrappers = document.querySelectorAll('.roll-select-wrapper');

rollSelectWrappers.forEach(wrapper => {
  const btn = wrapper.querySelector('.select-btn');
  const dropdown = wrapper.querySelector('.select-dropdown');
  const arrow = wrapper.querySelector('.arrow');

  // Проверяем, есть ли "Сырная шапочка" в списке
  let defaultTopping = 'Сырная шапочка';
  let exists = Array.from(dropdown.querySelectorAll('li')).some(li => li.textContent.trim() === defaultTopping);
  if (!exists) {
    const li = document.createElement('li');
    li.textContent = defaultTopping;
    dropdown.prepend(li);
  }

  // Устанавливаем значение по умолчанию
  btn.firstChild.textContent = defaultTopping + ' ';

  // Открытие/закрытие списка
  btn.addEventListener('click', (e) => {
    e.preventDefault();
    dropdown.classList.toggle('show');
    arrow.style.transform = dropdown.classList.contains('show') ? 'rotate(180deg)' : 'rotate(0deg)';
  });

  // Выбор элемента из списка
  dropdown.querySelectorAll('li').forEach(item => {
    item.addEventListener('click', () => {
      btn.firstChild.textContent = item.textContent + ' ';
      dropdown.classList.remove('show');
      arrow.style.transform = 'rotate(0deg)';
    });
  });

  // Закрытие при клике вне области
  document.addEventListener('click', (e) => {
    if (!wrapper.contains(e.target)) {
      dropdown.classList.remove('show');
      arrow.style.transform = 'rotate(0deg)';
    }
  });
});








// ===== НАСТРОЙКИ =====
const cartItemsContainer = document.querySelector('.cart-items');
const subtotalEl = document.querySelector('.subtotal-price');
const deliveryEl = document.querySelector('.delivery-price');
const discountEl = document.querySelector('.discount-price');
const totalEl = document.querySelector('.total-price');
const cartCountEl = document.querySelector('.cart-count');
const cartFullscreenEl = document.getElementById('cartFullscreen');
const cartBackdrop = document.getElementById('cartBackdrop');
const closeBtn = document.getElementById('closeCart');
const placeOrderBtn = document.getElementById('placeOrder');
const clearCartBtn = document.getElementById('clearCartBtn');
const checkoutForm = document.getElementById('checkoutForm');
const phoneInput = checkoutForm?.querySelector('input[name="phone"]');

if(phoneInput){
    phoneInput.addEventListener('input', () => {
        phoneInput.value = phoneInput.value.replace(/[^+\d]/g,'');
    });
}

let DELIVERY_COST = 5.00;
let FREE_DELIVERY_LIMIT = 50.00;
const ITEM_LIMIT = 20;
const cart = new Map();


// ===== LOCALSTORAGE =====
function saveCart(){ localStorage.setItem('cart', JSON.stringify(Object.fromEntries(cart))); }
function loadCart(){
    const data = localStorage.getItem('cart');
    if(data){
        const obj = JSON.parse(data);
        cart.clear();
        for(const [id,item] of Object.entries(obj)){
            cart.set(id,item);
        }
    }
}

// ===== TOAST =====
function showToast(msg, isRed=false){
    const toast = document.getElementById('toast');
    if(!toast) return;
    toast.textContent = msg;
    toast.className = 'toast show ' + (isRed?'red':'white');
    setTimeout(()=>toast.classList.remove('show'),2500);
}

// ===== ESCAPE HTML =====
function escapeHtml(str){ return String(str).replace(/[&<>"]/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s])); }

// ===== ДОБАВЛЕНИЕ В КОРЗИНУ =====
function addToCart(card){
    const ordersEnabled = document.getElementById('orders-disabled-note')?.style.display==='none';
    if(!ordersEnabled) return showToast('Заказы временно не принимаются', true);

    const id = card.dataset.id || card.querySelector('.title')?.textContent.trim();
    const name = card.querySelector('.title .name')?.textContent.trim() || 'Товар';
    const priceEl = card.querySelector('.price');
    const newPriceEl = priceEl?.querySelector('.new-price');
    const oldPriceEl = priceEl?.querySelector('.old-price');

    const unitPrice = newPriceEl
        ? parseFloat(newPriceEl.textContent.replace(/[^\d.,]/g,'').replace(',','.'))||0
        : parseFloat(priceEl?.textContent.replace(/[^\d.,]/g,'').replace(',','.'))||0;
    const originalPrice = oldPriceEl
        ? parseFloat(oldPriceEl.textContent.replace(/[^\d.,]/g,'').replace(',','.'))||unitPrice
        : unitPrice;

    if(cart.has(id)){
        const item = cart.get(id);
        if(item.qty<ITEM_LIMIT){
            item.qty++;
            cart.set(id,item);
            showToast('Товар добавлен в корзину');
        } else showToast(`Максимум ${ITEM_LIMIT} штук`, true);
    } else {
        cart.set(id,{name,unitPrice,originalPrice,qty:1});
        showToast('Товар добавлен в корзину');
    }

    saveCart();
    renderCart();
}

// ===== РЕНДЕР КОРЗИНЫ =====
function renderCart() {
    if (!cartItemsContainer) return;
    cartItemsContainer.innerHTML = '';

    const freeInfo = document.getElementById('free-delivery-info');
    if (FREE_DELIVERY_LIMIT > 0) {
        freeInfo.style.display = 'block';
        freeInfo.textContent = `Бесплатная доставка при покупке на сумму ${FREE_DELIVERY_LIMIT} €`;
    } else {
        freeInfo.style.display = 'none';
    }

    let subtotal = 0;
    cart.forEach((item, id) => subtotal += item.unitPrice * item.qty);


cart.forEach((item, id) => {
        const lineTotal = item.unitPrice * item.qty;

        const el = document.createElement('div');
        el.className = 'cart-item';
        el.dataset.id = id;

        el.innerHTML = `
            <div class="name">${escapeHtml(item.name)}</div>
            <div class="unit">
                ${item.unitPrice.toFixed(2)} €
                ${item.originalPrice && item.originalPrice > item.unitPrice ? `<span class="old-price">${item.originalPrice.toFixed(2)} €</span>` : ''}
            </div>
            <div class="qty-wrap">
                <button class="qty-btn btn-decr">−</button>
                <div class="qty-value">${item.qty}</div>
                <button class="qty-btn btn-incr">+</button>
            </div>
            <div class="line-total">${lineTotal.toFixed(2)} €</div>
            <button class="remove-btn">×</button>
        `;

                const incr = el.querySelector('.btn-incr');
        const decr = el.querySelector('.btn-decr');
        const removeBtn = el.querySelector('.remove-btn');

        incr.addEventListener('click', () => {
            if(item.unitPrice === 0) {
                showToast('Бесплатную позицию можно добавить только один раз', true);
                return;
            }
            if(item.qty < ITEM_LIMIT) item.qty++;
            cart.set(id, item);
            saveCart();
            renderCart();
        });

        decr.addEventListener('click', () => {
            if(item.qty > 1) {
                item.qty--;
                cart.set(id, item);
            } else {
                cart.delete(id);
            }
            saveCart();
            renderCart();
        });

        removeBtn.addEventListener('click', () => {
            cart.delete(id);
            saveCart();
            renderCart();
        });

        cartItemsContainer.appendChild(el);
    });

    let delivery = subtotal >= FREE_DELIVERY_LIMIT ? 0 : DELIVERY_COST;
      const method = checkoutForm?.method?.value?.toLowerCase();
    if (method === "самовывоз") delivery = 0;

    let discount = 0;

    if(activePromo) {
        switch(activePromo.type) {
            case 'cart_discount': discount = subtotal * (activePromo.value/100); break;
            case 'flat_discount': discount = activePromo.value; break;
            case 'min_total_discount': if(subtotal >= activePromo.min) discount = activePromo.value; break;
            case 'free_delivery': delivery = 0; break;
        }
    }

    const total = subtotal + delivery - discount;

    subtotalEl.textContent = subtotal.toFixed(2) + " €";
    deliveryEl.textContent = delivery.toFixed(2) + " €";
    discountEl.textContent =
        activePromo?.type === 'free_item'
        ? 'Бесплатная позиция'
        : discount > 0 ? '-' + discount.toFixed(2) + ' €' : '0.00 €';
    totalEl.textContent = total.toFixed(2) + " €";

    if(cartCountEl) {
        let cnt = 0;
        cart.forEach(i => cnt += i.qty);
        cartCountEl.textContent = cnt;
    }

    // Сохраняем корзину в localStorage
    saveCart();
}

// ===== ОБНОВЛЕНИЕ ПРИ СМЕНЕ СПОСОБА ПОЛУЧЕНИЯ =====
checkoutForm?.method?.addEventListener('change', renderCart);


// ===== OPEN/CLOSE =====
function openCart(){ cartFullscreenEl?.setAttribute('aria-hidden','false'); cartBackdrop?.classList.add('show'); }
function closeCart(){ cartFullscreenEl?.setAttribute('aria-hidden','true'); cartBackdrop?.classList.remove('show'); }
document.querySelector('.floating-cart')?.addEventListener('click',openCart);
closeBtn?.addEventListener('click',closeCart);
cartBackdrop?.addEventListener('click',closeCart);

// ===== ОЧИСТКА =====
clearCartBtn?.addEventListener('click',()=>{
    cart.clear();
    saveCart();
    renderCart();
    showToast('Корзина очищена');
});

// ====== Сохранение данных формы ======
if (checkoutForm) {
  // Загрузка при старте
  const savedForm = localStorage.getItem('checkoutFormData');
  if (savedForm) {
    const data = JSON.parse(savedForm);
    for (const key in data) {
      if (checkoutForm[key]) checkoutForm[key].value = data[key];
    }
  }

const addressInput = document.getElementById('deliveryAddress');

// загрузка сохранённого адреса
if (addressInput) {
    const savedAddress = localStorage.getItem('deliveryAddress');
    if (savedAddress) {
        addressInput.value = savedAddress;
    }

    // сохраняем при изменении
    addressInput.addEventListener('input', () => {
        localStorage.setItem('deliveryAddress', addressInput.value.trim());
    });
}


  // Сохраняем при изменении любого поля
  checkoutForm.addEventListener('input', () => {
    const data = {};
    Array.from(checkoutForm.elements).forEach(el => {
      if (el.name) data[el.name] = el.value;
    });
    localStorage.setItem('checkoutFormData', JSON.stringify(data));
  });
}

// ====== Очистка формы при оформлении заказа ======
placeOrderBtn?.addEventListener('click', () => {
    if (!checkoutForm) return;
    

    const name = checkoutForm.name.value.trim();
    const phone = checkoutForm.phone.value.trim();
    const email = checkoutForm.email.value.trim();
    const payment = checkoutForm.payment.value;
    const method = checkoutForm.method.value.toLowerCase();

    // ===== проверка корзины =====
    if (cart.size === 0) {
        showToast('В корзине нет товаров', true);
        return;
    }
    // ===== проверка основных полей =====
    if (!name || !phone || !email || !payment || !method) {
        showToast('Заполните все обязательные поля', true);
        return;
    }

    const isDelivery = method === 'доставка';
    const isPickup = method === 'самовывоз';

    const dateBtn = document.getElementById('chooseDateBtn');
    const timeSelect = document.getElementById('deliveryTime');
    const addressInput = document.getElementById('deliveryAddress');

    // ===== проверка даты =====
    if ((isDelivery || isPickup) && (!dateBtn || !dateBtn.textContent.includes('Дата'))) {
        showToast(isDelivery ? 'Заполните все обязательные поля' : 'Заполните все обязательные поля', true);
        return;
    }

    // ===== проверка времени =====
    if ((isDelivery || isPickup) && (!timeSelect || !timeSelect.value)) {
        showToast(isDelivery ? 'Заполните все обязательные поля' : 'Заполните все обязательные поля', true);
        return;
    }

    // ===== проверка адреса для доставки =====
    if (isDelivery && (!addressInput || !addressInput.value.trim())) {
        showToast('Заполните все обязательные поля', true);
        return;
    }

    // ===== проверка суммы =====
    const total = parseFloat(totalEl.textContent);
    if (total <= 0) {
        showToast('Сумма заказа должна быть больше 0 €', true);
        return;
    }

    // ===== оформление заказа =====
    showToast('Заказ принят — спасибо!');
    cart.clear();
    saveCart();
    renderCart();

    checkoutForm.reset();
    if (dateBtn) dateBtn.textContent = isDelivery ? 'Выбрать дату доставки' : 'Выбрать дату самовывоза';
    if (timeSelect) timeSelect.value = '';
    if (addressInput) addressInput.value = '';

    localStorage.removeItem('checkoutFormData');
    localStorage.removeItem('deliveryAddress');
    setTimeout(closeCart, 900);
});





// ========================================================
// 1. ЗАГРУЗКА ПРОМОКОДОВ ИЗ GOOGLE SHEETS
// ========================================================
const promoSheetUrl =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=1716078291&single=true&output=csv";

let promoCodes = {}; 
let activePromo = null;

// ===== Сохранение и загрузка промокода =====
function savePromo() {
  if (activePromo) localStorage.setItem('activePromo', JSON.stringify(activePromo));
  else localStorage.removeItem('activePromo');
}

function loadPromo() {
  const data = localStorage.getItem('activePromo');
  if (data) {
    activePromo = JSON.parse(data);
    promoInput.value = activePromo.code || '';
    if (activePromo.type === 'free_item' && activePromo.min > 0) {
      promoMessage.textContent = `Промокод "${activePromo.code}" активен при покупке от ${activePromo.min} €`;
    } else {
      promoMessage.textContent = `Промокод "${activePromo.code}" применён`;
    }
    promoMessage.style.color = 'green';
  }
}


async function loadPromoCodes() {
  try {
    const res = await fetch(promoSheetUrl);
    const csv = await res.text();
    const lines = csv.split("\n").map(l => l.trim());

    promoCodes = {};

    for (let i = 1; i < lines.length; i++) {
      if (!lines[i]) continue;

      const cols = lines[i].split(",");

      const code = cols[0]?.trim().toUpperCase();
      const type = cols[1]?.trim();
      const value = Number(cols[2]) || 0;
      const min = Number(cols[3]) || 0;
      const itemId = cols[4]?.trim();
      const enabled = cols[5]?.trim().toUpperCase() === "YES";

      if (!enabled || !code) continue;

      promoCodes[code] = { type };
      if (value) promoCodes[code].value = value;
      if (min) promoCodes[code].min = min;
      if (itemId) promoCodes[code].itemId = itemId;
    }

    console.log("Промокоды загружены:", promoCodes);
  } catch (err) {
    console.error("Ошибка загрузки промокодов:", err);
  }
}

loadPromoCodes();


// ========================================================
// 2. ЭЛЕМЕНТЫ И UI
// ========================================================
const showPromoBtn = document.getElementById('showPromoBtn');
const promoBox = document.querySelector('.promo-code-box');
const promoInput = document.getElementById('promoInput');
const applyPromoBtn = document.getElementById('applyPromo');
const cancelPromoBtn = document.querySelector('.promo-actions #cancelPromo');
const promoMessage = document.getElementById('promoMessage');

// Показываем поле ввода
showPromoBtn.addEventListener('click', () => {
  promoBox.style.display = 'block';
  showPromoBtn.style.display = 'none';
});

// Заглавные буквы
promoInput.addEventListener('input', () => {
  promoInput.value = promoInput.value.toUpperCase();
});

// Отмена кнопкой "Отмена" (UI)
document.getElementById("cancelPromo").addEventListener("click", () => {
  promoBox.style.display = "none";
  showPromoBtn.style.display = "block";
});


// ========================================================
// 3. ПРИМЕНЕНИЕ ПРОМОКОДА
// ========================================================
applyPromoBtn.addEventListener('click', () => {
  const code = promoInput.value.trim().toUpperCase();
  if (!code) return;

// ===== УДАЛЯЕМ бесплатный товар от предыдущего промокода =====
if (activePromo && activePromo.type === 'free_item') {
    const oldId = activePromo.itemId + '_promo';
    if (cart.has(oldId)) {
        cart.delete(oldId);
        saveCart();
    }
}


  if (promoCodes[code]) {
    activePromo = promoCodes[code];
    activePromo.code = code;
    savePromo();

    if (activePromo.type === 'free_item', 'min_total_discount' && activePromo.min > 0) {
      promoMessage.textContent = `Промокод "${code}" активен при покупке от ${activePromo.min} €`;
    } else {      
      promoMessage.textContent = `Промокод "${code}" применён`;
    }
    promoMessage.style.color = 'green';
  } else {
    promoMessage.textContent = 'Промокод не найден';
    promoMessage.style.color = 'red';
    activePromo = null;
  }

  renderCart();
});



// ========================================================
// 4. ОТМЕНА ПРОМОКОДА (ЛОГИКА)
// ========================================================
cancelPromoBtn.addEventListener('click', () => {
  // Удаляем бесплатный товар если был
  if (activePromo && activePromo.type === 'free_item') {
    const id = activePromo.itemId + '_promo';
    if (cart.has(id)) cart.delete(id);
  }

  activePromo = null;
  promoInput.value = '';
  promoMessage.textContent = '';

  renderCart();
});


// ========================================================
// 5. ОСНОВНАЯ ЛОГИКА ПРИ РЕНДЕРЕ КОРЗИНЫ
// ========================================================
function renderCart() {
  if (!cartItemsContainer) return;
  cartItemsContainer.innerHTML = '';


const freeInfo = document.getElementById('free-delivery-info');
if (FREE_DELIVERY_LIMIT > 0) {
    freeInfo.style.display = 'block';
    freeInfo.textContent = `Бесплатная доставка при покупке на сумму ${FREE_DELIVERY_LIMIT} €`;
} else {
    freeInfo.style.display = 'none';
}



  let subtotal = 0;
  cart.forEach((item, id) => subtotal += item.unitPrice * item.qty);


  // ======= ОБРАБОТКА БЕСПЛАТНОГО ТОВАРА =======
  if (activePromo && activePromo.type === 'free_item') {
    const promoId = activePromo.itemId + "_promo";
    const exists = cart.get(promoId);

    // Добавляем только если сумма достаточная и товара нет
    if (subtotal >= (activePromo.min || 0) && !exists) {
      const cardEl = document.querySelector(`.card[data-id="${activePromo.itemId}"]`);
      if (cardEl) {
        const name = cardEl.querySelector('.title .name')?.textContent.trim() || 'Товар';

        cart.set(promoId, {
          name,
          unitPrice: 0,
          originalPrice: 0,
          qty: 1,
          promoFree: true
        });
      }
    }

    // Удаляем если сумма стала ниже минимума
    if (subtotal < (activePromo.min || 0) && exists) {
      cart.delete(promoId);
    }
  }


  // ======= РЕНДЕР ТОВАРОВ =======
  cart.forEach((item, id) => {
    const lineTotal = item.unitPrice * item.qty;

    const el = document.createElement('div');
    el.className = 'cart-item';
    el.dataset.id = id;

    el.innerHTML = `
      <div class="name">${escapeHtml(item.name)}</div>
      <div class="unit">
        ${item.unitPrice.toFixed(2)} €
        ${item.originalPrice && item.originalPrice > item.unitPrice ? `<span class="old-price">${item.originalPrice.toFixed(2)} €</span>` : ''}
      </div>
      <div class="qty-wrap">
        <button class="qty-btn btn-decr">−</button>
        <div class="qty-value">${item.qty}</div>
        <button class="qty-btn btn-incr">+</button>
      </div>
      <div class="line-total">${lineTotal.toFixed(2)} €</div>
      <button class="remove-btn">×</button>
    `;

    const incr = el.querySelector('.btn-incr');
    const decr = el.querySelector('.btn-decr');
    const removeBtn = el.querySelector('.remove-btn');

    // + кнопка
    incr.addEventListener('click', () => {

    if (item.unitPrice === 0) {
        showToast('Бесплатную позицию можно добавить только один раз', true);
        return;
    }

    if (item.qty >= ITEM_LIMIT) {
        showToast(`Максимум ${ITEM_LIMIT} штук`, true);
        return;
    }
      if (item.qty < ITEM_LIMIT) item.qty++;
      cart.set(id, item);
      renderCart();
    });

    // - кнопка
    decr.addEventListener('click', () => {
      if (item.qty > 1) item.qty--;
      else cart.delete(id);
      renderCart();
    });

    // Удаление
    removeBtn.addEventListener('click', () => {
      cart.delete(id);
      renderCart();
    });

    cartItemsContainer.appendChild(el);
  });


  // ========================================================
  // 6. СКИДКИ, ДОСТАВКА, ИТОГИ
  // ========================================================

const checkoutForm = document.getElementById('checkoutForm');
const methodSelect = checkoutForm?.method;
const deliveryFields = document.getElementById('deliveryFields');
const deliveryNote = document.querySelector('.deliveryNote');
const chooseDateBtn = document.getElementById('chooseDateBtn');
const deliveryCalendar = document.getElementById('deliveryCalendar');
const deliveryTime = document.getElementById('deliveryTime');
const deliveryAddress = document.getElementById('deliveryAddress');

// ===== ЗАГРУЗКА ВРЕМЕНИ ДОСТАВКИ ИЗ GOOGLE SHEETS =====
const deliveryTimesSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=1115998539&single=true&output=csv";

// Теперь объект по дате и методу
let deliveryTimesByDate = {}; // ключ: "дд.мм.гггг|метод"

async function loadDeliveryTimes() {
    try {
        const res = await fetch(deliveryTimesSheetUrl);
        const csv = await res.text();
        const lines = csv.split("\n").map(l => l.trim());

        deliveryTimesByDate = {};

        for (let i = 1; i < lines.length; i++) {
            if (!lines[i]) continue;
            const [dateStr, method, time, active] = lines[i].split(",");
            if (!active || active.trim().toUpperCase() !== "YES") continue;
            if (!dateStr || !method || !time) continue;

            // Проверяем, есть ли диапазон дат
            if (dateStr.includes("-")) {
                const [startStr, endStr] = dateStr.split("-").map(s => s.trim());
                const [startDay, startMonth, startYear] = startStr.split(".").map(Number);
                const [endDay, endMonth, endYear] = endStr.split(".").map(Number);

                let current = new Date(startYear, startMonth - 1, startDay);
                const end = new Date(endYear, endMonth - 1, endDay);

                while (current <= end) {
                    const day = current.getDate().toString().padStart(2, "0");
                    const month = (current.getMonth() + 1).toString().padStart(2, "0");
                    const year = current.getFullYear();
                    const formatted = `${day}.${month}.${year}`;

                    const key = `${formatted}|${method.trim().toLowerCase()}`;
                    if (!deliveryTimesByDate[key]) deliveryTimesByDate[key] = [];
                    deliveryTimesByDate[key].push(time.trim());

                    current.setDate(current.getDate() + 1);
                }
            } else {
                const key = `${dateStr.trim()}|${method.trim().toLowerCase()}`;
                if (!deliveryTimesByDate[key]) deliveryTimesByDate[key] = [];
                deliveryTimesByDate[key].push(time.trim());
            }
        }

        updateDeliveryTimes(); // первый рендер
    } catch (err) {
        console.error("Ошибка загрузки времени доставки", err);
    }
}

function updateDeliveryTimes() {
    if (!deliveryTime) return;

    const method = methodSelect?.value?.toLowerCase();
    if (!method) return;

    deliveryTime.innerHTML = ""; // очищаем

    // placeholder — всегда показываем
    const placeholderOption = document.createElement('option');
    placeholderOption.value = "";
    placeholderOption.textContent = "Выбрать время *";
    placeholderOption.disabled = true;
    placeholderOption.selected = true;
    deliveryTime.appendChild(placeholderOption);

    // Если дата ещё не выбрана, пока не добавляем реальные слоты
    if (!selectedDate) return;

    const key = `${selectedDate}|${method}`;
    const times = deliveryTimesByDate[key] || [];

    if (times.length === 0) {
        const option = document.createElement('option');
        option.value = "";
        option.textContent = "Нет доступного времени";
        option.disabled = true;
        deliveryTime.appendChild(option);
        return;
    }

    times.forEach(t => {
        const optionEl = document.createElement('option');
        optionEl.value = t;
        optionEl.textContent = t;
        deliveryTime.appendChild(optionEl);
    });
}

// Обновляем при смене способа доставки
methodSelect?.addEventListener('change', updateDeliveryTimes);

// Загружаем сразу при старте
loadDeliveryTimes();



// обновление времени при смене метода
methodSelect?.addEventListener('change', updateDeliveryTimes);

// загрузка при старте
loadDeliveryTimes();



let selectedDate = null;
let blockedDates = new Set();
let blockedWeekday = false;
let blockedWeekend = false;

// ===== ЗАГРУЗКА GOOGLE SHEET =====
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRU16G77uq0XR1rGplEVVqn5-049-uhe-ycWu0DdNktVUOXvgfCMuV2pJwU-XPR8xLLCNdwOgh4q1Zs/pub?gid=425843351&single=true&output=csv";

async function loadBlockedDates() {
  try {
    const res = await fetch(sheetUrl);
    const csv = await res.text();
    const lines = csv.split("\n").map(l => l.trim());
    for(let i = 1; i < lines.length; i++){
      if(!lines[i]) continue;
      const [date, weekday, weekend] = lines[i].split(",");
      if(date) blockedDates.add(date.trim());
      if(weekday && weekday.trim().toUpperCase() === "YES") blockedWeekday = true;
      if(weekend && weekend.trim().toUpperCase() === "YES") blockedWeekend = true;
    }
  } catch(err) {
    console.error("Ошибка загрузки Google Sheet", err);
  }
}

// ===== ОБНОВЛЕНИЕ ПОЛЕЙ ДЛЯ ДОСТАВКИ =====
function updateDeliveryFields() {
  const method = methodSelect.value?.toLowerCase();

  if(method === "доставка" || method === "самовывоз"){
    deliveryFields.style.display = "block";

    if(method === "доставка"){
      deliveryNote.style.display = "block";        
      deliveryAddress.style.display = "block";     
    } else { 
      deliveryNote.style.display = "none";         
      deliveryAddress.style.display = "none";      
    }
  } else {
    deliveryFields.style.display = "none";
    deliveryCalendar.style.display = "none";
    selectedDate = null;
    chooseDateBtn.textContent = "Выбрать дату доставки";
  }
}

methodSelect?.addEventListener('change', updateDeliveryFields);
updateDeliveryFields();

// ===== ОТКРЫТИЕ КАЛЕНДАРЯ =====
chooseDateBtn?.addEventListener('click', () => {
  deliveryCalendar.style.display = "block";
  renderCalendar();
});

// ===== РЕНДЕР КАЛЕНДАРЯ =====
function renderCalendar() {
  deliveryCalendar.innerHTML = '';
  const today = new Date();
  const maxDate = new Date();
  maxDate.setDate(today.getDate() + 6);

  const dates = [];
  const current = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  while(current <= maxDate){
    dates.push(new Date(current));
    current.setDate(current.getDate() + 1);
  }

  const months = {};
  dates.forEach(d => {
    const key = d.getFullYear() + '-' + (d.getMonth()+1);
    if(!months[key]) months[key] = [];
    months[key].push(d);
  });

  for(const [key, monthDates] of Object.entries(months)){
    const monthLabel = document.createElement('div');
    monthLabel.className = 'month-label';
    monthLabel.textContent = monthDates[0].toLocaleString('default', { month: 'long', year: 'numeric' });
    monthLabel.style.marginTop = "20px";
    deliveryCalendar.appendChild(monthLabel);

    const daysContainer = document.createElement('div');
    daysContainer.className = 'days';

    const firstDate = new Date(monthDates[0].getFullYear(), monthDates[0].getMonth(), 1);
    const lastDate = new Date(monthDates[0].getFullYear(), monthDates[0].getMonth() + 1, 0);

    const startDay = (firstDate.getDay() + 6) % 7;
    for(let i=0; i<startDay; i++){
      const emptyDiv = document.createElement('div');
      daysContainer.appendChild(emptyDiv);
    }

    for(let day=1; day<=lastDate.getDate(); day++){
      const date = new Date(firstDate.getFullYear(), firstDate.getMonth(), day);
      const dayDiv = document.createElement('div');
      dayDiv.className = 'day';
      dayDiv.textContent = day;

      const isoDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2,'0')}-${date.getDate().toString().padStart(2,'0')}`;
      dayDiv.dataset.date = isoDate;

      // Блокировка по Google Sheets
      const isWeekend = (date.getDay() === 0 || date.getDay() === 6);
      const isWeekday = (date.getDay() >= 1 && date.getDay() <= 5);

      if(dates.some(d => d.getDate()===date.getDate() && d.getMonth()===date.getMonth() && d.getFullYear()===date.getFullYear())){
        dayDiv.classList.add('available');
        if(blockedDates.has(`${date.getDate().toString().padStart(2,'0')}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getFullYear()}`) ||
           (blockedWeekend && isWeekend) ||
           (blockedWeekday && isWeekday)){
          dayDiv.classList.remove('available');
          dayDiv.classList.add('unavailable');
        }
      } else {
        dayDiv.classList.add('unavailable');
      }

      if(selectedDate === isoDate){
        dayDiv.classList.add('selected');
      }

      dayDiv.addEventListener('click', () => {
    if(dayDiv.classList.contains('unavailable')) return;

    const [year, month, day] = isoDate.split('-').map(Number);

    // selectedDate в формате дд.мм.гггг
    selectedDate = `${day.toString().padStart(2,'0')}.${month.toString().padStart(2,'0')}.${year}`;

    chooseDateBtn.textContent = "Дата: " + selectedDate;
    deliveryCalendar.style.display = "none";

    renderCalendar();
    updateDeliveryTimes(); // сразу обновляем список времени для выбранной даты
});


      daysContainer.appendChild(dayDiv);
    }

    deliveryCalendar.appendChild(daysContainer);
  }
}

// ===== ЗАГРУЗКА БЛОКИРОВОК И СТАРТОВЫЙ РЕНДЕР =====
loadBlockedDates().then(() => renderCalendar());










  let delivery = subtotal >= FREE_DELIVERY_LIMIT ? 0 : DELIVERY_COST;
  const method = checkoutForm?.method?.value?.toLowerCase();
    if (method === "самовывоз") delivery = 0;

    let discount = 0;

  if (activePromo) {
    switch (activePromo.type) {
      case 'cart_discount':
        discount = subtotal * (activePromo.value / 100);
        break;

      case 'flat_discount':
        discount = activePromo.value;
        break;

      case 'min_total_discount':
        if (subtotal >= activePromo.min) discount = activePromo.value;
        break;

      case 'free_delivery':
        delivery = 0;
        break;
    }
  }


// ===== СКИДКА (ПОКАЗЫВАЕМ ТОЛЬКО ЕСЛИ ЕСТЬ) =====
const discountRow = discountEl.parentElement;

if (
  (activePromo && activePromo.type === "free_item") ||
  discount > 0
) {
  discountRow.style.display = '';
  discountEl.textContent =
    activePromo?.type === "free_item"
      ? "Бесплатная позиция"
      : "-" + discount.toFixed(2) + " €";
} else {
  discountRow.style.display = 'none';
}

  const total = subtotal + delivery - discount;
  subtotalEl.textContent = subtotal.toFixed(2) + " €";
  deliveryEl.textContent = delivery.toFixed(2) + " €";
    totalEl.textContent = total.toFixed(2) + " €";

  // Значок количества в корзине
  if (cartCountEl) {
    let cnt = 0;
    cart.forEach(i => cnt += i.qty);
    cartCountEl.textContent = cnt;
  }
  saveCart();
  savePromo();
}




// ===== ИНИЦИАЛЬНЫЙ РЕНДЕР =====
loadCart();
loadPromo();

// ===== АВТОРАСКРЫТИЕ ПРОМОБЛОКА ПРИ ПЕРЕЗАГРУЗКЕ =====
if (localStorage.getItem('activePromo')) {
    promoBox.style.display = 'block';
    showPromoBtn.style.display = 'none';
}


renderCart();

</script>
</body>
</html>